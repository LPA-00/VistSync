<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema de Agendamento de Vistorias</title>
    <style>
        :root {
            --verde-principal: rgb(52, 69, 55);
            --verde-claro: rgb(72, 95, 75);
            --branco: #f5f5f5;
            --cinza: #e0e0e0;
            --vermelho: #e74c3c;
            --azul: #3498db;
            --laranja: #e67e22; /* Nova cor para horário selecionado */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--branco);
            font-family: Arial, sans-serif;
            color: var(--verde-principal);
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 0 20px;
            flex-wrap: wrap;
        }

        .header h1 {
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background-color: var(--azul);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .nav-btn:hover {
            background-color: #2980b9;
        }

        .nav-btn.active {
            background-color: var(--verde-principal);
        }

        h1, h2 { text-align: center; margin-bottom: 20px; }

        .card-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .card {
            background-color: var(--verde-principal);
            color: var(--branco);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            width: 180px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .card:hover { transform: scale(1.05); }

        .hidden { display: none !important; }

        .selector, .back-button { margin-top: 20px; text-align: center; }

        .selector button, .back-button button {
            background-color: var(--verde-claro);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }

        .selector button:hover, .back-button button:hover {
            background-color: var(--verde-principal);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            max-width: 700px;
            margin: 0 auto;
        }

        .header-cell {
            font-weight: bold;
            text-align: center;
            padding: 10px 0;
        }

        .day-card {
            background-color: var(--cinza);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            position: relative;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-card:hover {
            background-color: var(--verde-claro);
            color: white;
        }

        .icon-red {
            color: var(--vermelho);
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 18px;
        }
        
        .day-hours-container {
            display: flex;
            flex-direction: column; /* Changed to column for better stacking */
            align-items: center;
            gap: 10px;
            margin-bottom: 20px; /* Space before action buttons */
        }

        .hour {
            background-color: var(--cinza);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            margin: 5px;
            min-width: 80px;
        }

        .hour:hover {
            background-color: var(--verde-claro);
            color: white;
        }

        .hour.selected { /* Estilo para horário selecionado */
            background-color: var(--laranja);
            color: white;
            border: 2px solid #d35400;
        }

        .action-buttons { /* Novo estilo para o contêiner dos botões de ação */
            text-align: center;
            margin-top: 20px;
        }

        .action-buttons button {
            background-color: var(--verde-principal);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .action-buttons button:hover {
            background-color: var(--verde-claro);
        }


        .form {
            margin-top: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            background-color: var(--cinza);
            padding: 20px;
            border-radius: 12px;
        }

        .form input, .form textarea {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: inherit;
        }

        .form button {
            background-color: var(--verde-principal);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .form button:hover {
            background-color: var(--verde-claro);
        }
        .form button[type="button"] {
            background-color: var(--vermelho);
        }
        .form button[type="button"]:hover {
            background-color: #c0392b;
        }


        .no-available {
            color: var(--vermelho);
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .week-grid > div {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--cinza);
        }

        /* Estilos para relatórios */
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .filter-section {
            background-color: var(--cinza);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            font-size: 14px;
        }

        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            min-width: 150px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .export-btn {
            background-color: var(--azul);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .export-btn:hover {
            background-color: #2980b9;
        }

        .table-container {
            overflow-x: auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--verde-principal);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-agendado {
            background-color: #e8f5e8;
            color: #2d5016;
        }

        .action-btn {
            background-color: var(--vermelho);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn:hover {
            background-color: #c0392b;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--verde-principal);
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sistema de Agendamento de Vistorias</h1>
        <div class="nav-buttons">
            <button class="nav-btn active" id="btn-agendar" onclick="showSection('agendamento')">Agendar</button>
            <button class="nav-btn" id="btn-relatorios" onclick="showSection('relatorios')">Relatórios</button>
        </div>
    </div>

    <div id="section-agendamento">
        <div class="card-container" id="collaborators">
            </div>

        <div class="selector hidden" id="selector">
            <h2 id="selectedCollaborator"></h2>
            <button onclick="showWeek()">Semana</button>
            <button onclick="showMonth()">Mês</button>
        </div>

        <div class="back-button hidden" id="backButton">
            <button onclick="goBack()">⬅ Voltar</button>
        </div>

        <div class="calendar hidden" id="calendar">
            </div>

        <div class="day-hours hidden" id="dayHours">
             <div class="action-buttons" id="dayHoursActionButtons">
                 </div>
        </div>
        
        <div class="week-view hidden" id="weekView">
            <div class="action-buttons" id="weekViewActionButtons">
                 </div>
        </div>

        <div class="form" id="form">
            <h3>Detalhes do Agendamento</h3>
            <input type="text" id="nome" placeholder="Nome do responsável *" required>
            <input type="text" id="empreendimento" placeholder="Empreendimento *" required>
            <input type="text" id="local" placeholder="Local (Ex: Ap 101) *" required>
            <input type="tel" id="telefone" placeholder="Telefone">
            <textarea id="observacoes" placeholder="Observações (opcional)" rows="3"></textarea>
            <button onclick="book()">Agendar</button>
            <button type="button" onclick="cancelForm()">Cancelar</button>
        </div>
    </div>

    <div id="section-relatorios" class="hidden">
        <div class="report-container">
            <div class="filter-section">
                <h3>Filtros</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filter-colaborador">Colaborador:</label>
                        <select id="filter-colaborador">
                            <option value="">Todos</option>
                            </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-inicio">Data Inicial:</label>
                        <input type="date" id="filter-data-inicio">
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-fim">Data Final:</label>
                        <input type="date" id="filter-data-fim">
                    </div>
                    <div class="filter-group">
                        <label for="filter-empreendimento">Empreendimento:</label>
                        <input type="text" id="filter-empreendimento" placeholder="Filtrar por empreendimento">
                    </div>
                    <div class="filter-group">
                        <label> </label>
                        <button class="nav-btn" onclick="applyFilters()">Filtrar</button>
                    </div>
                </div>
            </div>

            <div class="stats-container" id="stats-container">
                </div>

            <div class="export-buttons">
                <button class="export-btn" onclick="exportToCSV()">Exportar CSV</button>
                <button class="export-btn" onclick="exportToPDF()">Exportar PDF</button>
                <button class="export-btn" style="background-color: var(--vermelho);" onclick="clearAllData()">Limpar Todos os Dados</button>
            </div>

            <div class="table-container">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Colaborador</th>
                            <th>Responsável</th>
                            <th>Empreendimento</th>
                            <th>Local</th>
                            <th>Telefone</th>
                            <th>Observações</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
const horarios = ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
// Adicione ou remova colaboradores aqui para que apareçam na tela e no filtro
const colaboradores = ["Cleber", "Devilson", "Mariana"]; 
let currentAgendamentos = {}; // Local cache of agendamentos
let selectedCollaborator = '';
let selectedDate = ''; // Format: YYYY-MM-DD
let selectedHours = []; // Array para múltiplos horários { date: 'YYYY-MM-DD', hour: 'HH:mm', element: HTMLDivElement }

const STORAGE_KEY = 'vistoriasAgendamentos'; // Mantido por compatibilidade, mas não usado diretamente para a planilha

// --- DataManager START ---
class DataManager {
    static async getAgendamentos() {
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbzAUEEKLGCEUq4meIjEiB90hafocMbgwxUVsATNonvBDarXOwl4TMsZNIDwgC5SeZzO/exec');
            const agendamentosArray = await response.json();

            const agendamentos = {};
            for (const ag of agendamentosArray) {
                const key = `${ag.colaborador}_${ag.data}_${ag.hora}`;
                agendamentos[key] = ag;
            }
            return agendamentos;
        } catch (error) {
            console.error("Erro ao buscar agendamentos do Google Sheets:", error);
            return {};
        }
    }

    static async getAllAgendamentosArray() {
        const agendamentos = await this.getAgendamentos();
        const result = [];
        for (const [key, data] of Object.entries(agendamentos)) {
            const [colaborador, date_str, horario] = key.split('_');
            result.push({
                key,
                colaborador,
                data: date_str,
                horario,
                ...data
            });
        }
        return result.sort((a, b) => {
            const dateA = new Date(`${a.data}T${a.horario}`);
            const dateB = new Date(`${b.data}T${b.horario}`);
            return dateA - dateB;
        });
    }

    static async addAgendamento(data) {
        try {
            const response = await fetch(
                'https://script.google.com/macros/s/AKfycbzAUEEKLGCEUq4meIjEiB90hafocMbgwxUVsATNonvBDarXOwl4TMsZNIDwgC5SeZzO/exec',
                {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }
            );
            console.log('Agendamento enviado para a planilha.');
            return { success: true };
        } catch (err) {
            console.error('Falha ao enviar para a planilha:', err);
            return { success: false, error: err.message };
        }
    }

    static async removeAgendamento(key) {
        if (!key) {
            console.error("Chave de agendamento inválida para remoção.");
            return { success: false, error: "Chave inválida" };
        }
        try {
            const response = await fetch(
                'https://script.google.com/macros/s/AKfycbzAUEEKLGCEUq4meIjEiB90hafocMbgwxUVsATNonvBDarXOwl4TMsZNIDwgC5SeZzO/exec',
                {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'delete', key: key })
                }
            );
            console.log('Solicitação de exclusão enviada.');
            return { success: true };
        } catch (err) {
            console.error('Falha ao enviar solicitação de exclusão para a planilha:', err);
            return { success: false, error: err.message };
        }
    }

    static async clearAllData() {
        if (confirm('ATENÇÃO: Tem certeza que deseja limpar TODOS os dados de agendamento? Esta ação é irreversível!')) {
            try {
                const response = await fetch(
                    'https://script.google.com/macros/s/AKfycbzAUEEKLGCEUq4meIjEiB90hafocMbgwxUVsATNonvBDarXOwl4TMsZNIDwgC5SeZzO/exec',
                    {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ action: 'clearAll' })
                    }
                );
                alert('Todos os dados foram solicitados para exclusão. A planilha será esvaziada em breve.');
                currentAgendamentos = {};
                await loadReports();
                resetAgendamentoView();
            } catch (error) {
                console.error("Erro ao tentar limpar todos os dados:", error);
                alert("Ocorreu um erro ao tentar limpar os dados. Verifique o console para mais detalhes.");
            }
        }
    }
}
// --- DataManager END ---

async function initializeApp() {
    await renderCollaboratorCards(); // Carrega os cards de colaboradores ao iniciar
    await populateFilterCollaborators(); // Popula o filtro de colaboradores
    currentAgendamentos = await DataManager.getAgendamentos();
    const today = new Date().toISOString().split('T')[0];
    const dataInicioFilter = document.getElementById('filter-data-inicio');
    const dataFimFilter = document.getElementById('filter-data-fim');
    if (!dataInicioFilter.value) dataInicioFilter.value = today;
    if (!dataFimFilter.value) dataFimFilter.value = today;
    
    showSection('agendamento'); // Default section
}

async function renderCollaboratorCards() {
    const container = document.getElementById('collaborators');
    container.innerHTML = ''; // Limpa os cards existentes
    colaboradores.forEach(colaborador => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerText = colaborador;
        card.onclick = () => selectCollaborator(colaborador);
        container.appendChild(card);
    });
}

async function populateFilterCollaborators() {
    const select = document.getElementById('filter-colaborador');
    select.innerHTML = '<option value="">Todos</option>'; // Opção padrão
    colaboradores.forEach(colaborador => {
        const option = document.createElement('option');
        option.value = colaborador;
        option.innerText = colaborador;
        select.appendChild(option);
    });
}

async function showSection(section) {
    document.getElementById('section-agendamento').classList.add('hidden');
    document.getElementById('section-relatorios').classList.add('hidden');
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

    const targetSectionId = `section-${section}`;
    const targetButtonId = `btn-${section === 'agendamento' ? 'agendar' : 'relatorios'}`;

    document.getElementById(targetSectionId).classList.remove('hidden');
    document.getElementById(targetButtonId).classList.add('active');

    if (section === 'relatorios') {
        await loadReports();
    } else {
        currentAgendamentos = await DataManager.getAgendamentos(); 
        resetAgendamentoView();
    }
}

function resetAgendamentoView() {
    clearScreensAndForm();
    document.getElementById('collaborators').classList.remove('hidden');
    document.getElementById('selector').classList.add('hidden');
    document.getElementById('backButton').classList.add('hidden');
    selectedCollaborator = '';
    selectedDate = '';
    selectedHours = []; 
    updateConfirmButtonVisibility(); // Garante que botões de confirmar estejam ocultos
}

function selectCollaborator(nome) {
    selectedCollaborator = nome;
    document.getElementById('collaborators').classList.add('hidden');
    document.getElementById('selector').classList.remove('hidden');
    document.getElementById('selectedCollaborator').innerText = `Agendar para: ${nome}`;
    document.getElementById('backButton').classList.remove('hidden');
    // Não chame showWeek/showMonth aqui, deixe o usuário escolher
}

function goBack() {
    const form = document.getElementById('form');
    const dayHours = document.getElementById('dayHours');
    const calendar = document.getElementById('calendar');
    const weekView = document.getElementById('weekView');
    const selector = document.getElementById('selector');

    if (form.style.display === 'flex') {
        cancelForm(); 
    } else if (!dayHours.classList.contains('hidden')) {
        showMonth();
        selectedHours = [];
        updateConfirmButtonVisibility();
    } else if (!weekView.classList.contains('hidden')) {
        clearScreensAndForm();
        selector.classList.remove('hidden');
        selectedHours = [];
        updateConfirmButtonVisibility();
    } else if (!calendar.classList.contains('hidden')) {
        clearScreensAndForm();
        selector.classList.remove('hidden');
    } else if (!selector.classList.contains('hidden')) {
        resetAgendamentoView();
    }
}

async function showMonth() {
    clearScreensAndForm();
    currentAgendamentos = await DataManager.getAgendamentos();
    selectedHours = []; 
    updateConfirmButtonVisibility();

    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = '';
    calendarEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();

    const monthName = today.toLocaleString('pt-BR', { month: 'long' });
    calendarEl.innerHTML = `<h2>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} / ${year}</h2>`;

    const firstDayOfMonth = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const grid = document.createElement('div');
    grid.className = 'calendar-grid';

    const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
    weekDays.forEach(day => grid.innerHTML += `<div class='header-cell'>${day}</div>`);

    for (let i = 0; i < firstDayOfMonth; i++) {
        grid.innerHTML += `<div></div>`;
    }

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        let hasAvailable = false;
        if (new Date(dateStr) >= new Date(new Date().toDateString())) {
            hasAvailable = horarios.some(h => !currentAgendamentos[`${selectedCollaborator}_${dateStr}_${h}`]);
        }

        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (new Date(dateStr) < new Date(new Date().toDateString())) {
            dayCard.style.backgroundColor = '#dddddd';
            dayCard.style.cursor = 'not-allowed';
            dayCard.innerHTML = `${d}`;
        } else {
            dayCard.innerHTML = `${hasAvailable ? '' : '<div class="icon-red">🔴</div>'}${d}`;
            dayCard.onclick = () => openDay(dateStr);
        }
        grid.appendChild(dayCard);
    }
    calendarEl.appendChild(grid);
}

async function showWeek() {
    clearScreensAndForm();
    currentAgendamentos = await DataManager.getAgendamentos();
    selectedHours = []; 
    updateConfirmButtonVisibility();

    const weekViewEl = document.getElementById('weekView');
    weekViewEl.innerHTML = '<h2>Próximos 5 Dias Úteis</h2>';
    weekViewEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const today = new Date();
    const weekDates = [];
    let currentDate = new Date(today);

    if (currentDate.getDay() === 0) currentDate.setDate(currentDate.getDate() + 1);
    if (currentDate.getDay() === 6) currentDate.setDate(currentDate.getDate() + 2);

    for (let i = 0; i < 5; i++) {
        while (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
            currentDate.setDate(currentDate.getDate() + 1);
        }

        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
        const dayLabel = currentDate.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
        weekDates.push({ label: `${dayLabel} (${currentDate.getDate()}/${currentDate.getMonth() + 1})`, dateStr });
        currentDate.setDate(currentDate.getDate() + 1);
    }

    const grid = document.createElement('div');
    grid.className = 'week-grid';

    weekDates.forEach(day => {
        const column = document.createElement('div');
        const header = document.createElement('div');
        header.className = 'header-cell';
        header.innerText = day.label;
        column.appendChild(header);

        let availableSlots = false;
        horarios.forEach(hora => {
            const key = `${selectedCollaborator}_${day.dateStr}_${hora}`;
            if (!currentAgendamentos[key]) {
                availableSlots = true;
                const btn = document.createElement('div');
                btn.className = 'hour';
                btn.innerText = hora;
                btn.onclick = () => toggleHourSelection(day.dateStr, hora, btn);
                column.appendChild(btn);
            }
        });

        if (!availableSlots) {
            const noAvailable = document.createElement('div');
            noAvailable.className = 'no-available';
            noAvailable.innerHTML = '🔴';
            column.appendChild(noAvailable);
        }
        grid.appendChild(column);
    });
    weekViewEl.appendChild(grid);

    // Adiciona o botão de confirmar agendamento para a semana
    renderConfirmButton('week');
}

function openDay(dateStr) {
    clearScreensAndForm();
    selectedDate = dateStr; 
    selectedHours = []; 
    updateConfirmButtonVisibility();

    const dayHoursEl = document.getElementById('dayHours');
    dayHoursEl.innerHTML = '';
    dayHoursEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const formattedDate = formatDateToBR(dateStr);
    dayHoursEl.innerHTML = `<h2>Horários para ${formattedDate}</h2>`;
    
    const container = document.createElement('div');
    container.className = 'day-hours-container';

    let available = false;
    if (new Date(dateStr) < new Date(new Date().toDateString())) {
        const pastDateMsg = document.createElement('div');
        pastDateMsg.className = 'no-available';
        pastDateMsg.innerText = 'Não é possível agendar em datas passadas.';
        container.appendChild(pastDateMsg);
    } else {
        horarios.forEach(hora => {
            const key = `${selectedCollaborator}_${dateStr}_${hora}`;
            if (!currentAgendamentos[key]) {
                available = true;
                const hourBtn = document.createElement('div');
                hourBtn.className = 'hour';
                hourBtn.innerText = hora;
                hourBtn.onclick = () => toggleHourSelection(dateStr, hora, hourBtn);
                container.appendChild(hourBtn);
            }
        });
    }

    if (!available && new Date(dateStr) >= new Date(new Date().toDateString())) {
        const noAvailable = document.createElement('div');
        noAvailable.className = 'no-available';
        noAvailable.innerText = '🔴 Sem horários disponíveis para este dia.';
        container.appendChild(noAvailable);
    }
    dayHoursEl.appendChild(container);

    renderConfirmButton('day');

    const backBtnDiv = document.createElement('div');
    backBtnDiv.className = 'back-button';
    backBtnDiv.style.marginTop = '20px';
    const specificBackBtn = document.createElement('button');
    specificBackBtn.innerHTML = '⬅ Voltar para o Calendário Mensal';
    specificBackBtn.onclick = () => showMonth();
    backBtnDiv.appendChild(specificBackBtn);
    dayHoursEl.appendChild(backBtnDiv);
}

function toggleHourSelection(date, hour, element) {
    const timeSlot = { date, hour, element }; // Store element reference
    const index = selectedHours.findIndex(s => s.date === date && s.hour === hour);

    if (index > -1) {
        selectedHours.splice(index, 1);
        element.classList.remove('selected');
    } else {
        selectedHours.push(timeSlot);
        element.classList.add('selected');
    }
    updateConfirmButtonVisibility();
}

function updateConfirmButtonVisibility() {
    const confirmButtonDay = document.querySelector('#dayHoursActionButtons button');
    const confirmButtonWeek = document.querySelector('#weekViewActionButtons button');

    if (confirmButtonDay) {
        confirmButtonDay.style.display = selectedHours.length > 0 ? 'inline-block' : 'none';
    }
    if (confirmButtonWeek) {
        confirmButtonWeek.style.display = selectedHours.length > 0 ? 'inline-block' : 'none';
    }
}

function renderConfirmButton(view) {
    const containerId = view === 'day' ? 'dayHoursActionButtons' : 'weekViewActionButtons';
    const container = document.getElementById(containerId);
    if (!container) return; // Safeguard if container is not found

    // Only add button if it doesn't exist
    if (!container.querySelector('button')) {
        const confirmBtn = document.createElement('button');
        confirmBtn.innerText = 'Confirmar Agendamento(s)';
        confirmBtn.onclick = showForm;
        confirmBtn.style.display = 'none'; // Esconde inicialmente
        confirmBtn.style.marginTop = '20px'; // Adiciona um espaçamento
        container.appendChild(confirmBtn);
    }
    updateConfirmButtonVisibility(); // Garante que a visibilidade seja atualizada
}


function showForm() {
    if (selectedHours.length === 0) {
        alert('Por favor, selecione ao menos um horário para agendar.');
        return;
    }
    document.getElementById('form').style.display = 'flex';
    // Esconder todas as outras views de agendamento antes de mostrar o formulário
    document.getElementById('dayHours').classList.add('hidden'); 
    document.getElementById('weekView').classList.add('hidden'); 
    document.getElementById('calendar').classList.add('hidden'); 
    document.getElementById('selector').classList.add('hidden'); // Esconde também o selector (Semana/Mês)
    document.getElementById('backButton').classList.remove('hidden'); // Mantenha o botão de voltar geral

    document.getElementById('nome').focus();
}

async function book() {
    const nome = document.getElementById('nome').value.trim();
    const empreendimento = document.getElementById('empreendimento').value.trim();
    const local = document.getElementById('local').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const observacoes = document.getElementById('observacoes').value.trim();

    if (!nome || !empreendimento || !local) {
        alert('Preencha os campos obrigatórios: Nome, Empreendimento e Local!');
        return;
    }

    if (selectedHours.length === 0) {
        alert('Nenhum horário selecionado para agendar. Por favor, selecione um horário.');
        return;
    }

    const successfulBookings = [];
    const failedBookings = [];

    // Desabilitar o formulário enquanto os agendamentos são processados
    document.getElementById('form').querySelectorAll('input, textarea, button').forEach(el => el.disabled = true);

    for (const slot of selectedHours) {
        const { date, hour, element } = slot;
        const bookingData = {
            nome,
            empreendimento,
            local,
            telefone,
            observacoes,
            colaborador: selectedCollaborator,
            dataAgendada: date,
            horaAgendada: hour
        };

        const key = `${selectedCollaborator}_${date}_${hour}`;
        if (currentAgendamentos[key]) {
            failedBookings.push(`${formatDateToBR(date)} às ${hour} (já agendado por outro)`);
            if (element) element.classList.remove('selected'); // Desmarca visualmente
            continue;
        }

        const result = await DataManager.addAgendamento(bookingData);
        if (result.success) {
            successfulBookings.push(`${formatDateToBR(date)} às ${hour}`);
            currentAgendamentos[key] = bookingData; // Atualiza o cache local
            if (element) element.classList.remove('selected'); // Desmarca visualmente
        } else {
            failedBookings.push(`${formatDateToBR(date)} às ${hour} (erro ao agendar)`);
            if (element) element.classList.remove('selected'); // Desmarca visualmente
        }
        await new Promise(resolve => setTimeout(resolve, 300));
    }

    // Reabilitar o formulário
    document.getElementById('form').querySelectorAll('input, textarea, button').forEach(el => el.disabled = false);

    let message = '';
    if (successfulBookings.length > 0) {
        message += `Agendamento(s) realizado(s) com sucesso para ${selectedCollaborator}:\n${successfulBookings.join('\n')}\n\n`;
    }
    if (failedBookings.length > 0) {
        message += `Erro ao agendar os seguintes horários:\n${failedBookings.join('\n')}\n(Podem já ter sido agendados por outra pessoa ou houve um problema)`;
    }
    if (message) {
        alert(message);
    } else {
        alert('Nenhum agendamento foi realizado.');
    }
    
    clearForm();
    resetAgendamentoView();
}

function clearForm() {
    const form = document.getElementById('form');
    form.style.display = 'none';
    document.getElementById('nome').value = '';
    document.getElementById('empreendimento').value = '';
    document.getElementById('local').value = '';
    document.getElementById('telefone').value = '';
    document.getElementById('observacoes').value = '';
    selectedHours = []; // Limpa horários selecionados
    // Garante que os elementos visuais dos horários também sejam desmarcados
    document.querySelectorAll('.hour.selected').forEach(el => el.classList.remove('selected'));
    updateConfirmButtonVisibility(); // Oculta o botão de confirmar se não há horários
}

function cancelForm() {
    clearForm();
    // Tenta voltar para a visualização anterior de forma inteligente
    if (selectedDate) { // Se uma data estava selecionada, tenta voltar para o dia
        openDay(selectedDate);
    } else if (selectedCollaborator) { // Se um colaborador estava selecionado, mas nenhuma data, volta para o selector
        clearScreensAndForm();
        document.getElementById('selector').classList.remove('hidden');
        document.getElementById('backButton').classList.remove('hidden');
    } else { // Caso contrário, volta para a seleção de colaborador
        resetAgendamentoView();
    }
}

function clearScreensAndForm() {
    document.getElementById('calendar').classList.add('hidden');
    document.getElementById('dayHours').classList.add('hidden');
    document.getElementById('weekView').classList.add('hidden');
    // Certifique-se de limpar os botões de ação também
    document.getElementById('dayHoursActionButtons').innerHTML = '';
    document.getElementById('weekViewActionButtons').innerHTML = '';
    clearForm(); // Isso também limpa selectedHours e desmarca elementos visuais
}

// --- Funções de Relatório ---
async function loadReports() {
    await applyFilters();
    await updateStats();
}

async function applyFilters() {
    const colaboradorFilter = document.getElementById('filter-colaborador').value;
    let dataInicioFilter = document.getElementById('filter-data-inicio').value;
    let dataFimFilter = document.getElementById('filter-data-fim').value;
    const empreendimentoFilter = document.getElementById('filter-empreendimento').value.toLowerCase();

    let dados = await DataManager.getAllAgendamentosArray();

    dataInicioFilter = dataInicioFilter ? new Date(dataInicioFilter + 'T00:00:00Z') : null;
    dataFimFilter = dataFimFilter ? new Date(dataFimFilter + 'T00:00:00Z') : null;

    if (colaboradorFilter) {
        dados = dados.filter(item => item.colaborador === colaboradorFilter);
    }
    if (dataInicioFilter) {
        dados = dados.filter(item => new Date(item.data + 'T00:00:00Z') >= dataInicioFilter);
    }
    if (dataFimFilter) {
        dados = dados.filter(item => new Date(item.data + 'T00:00:00Z') <= dataFimFilter);
    }
    if (empreendimentoFilter) {
        dados = dados.filter(item => item.empreendimento.toLowerCase().includes(empreendimentoFilter));
    }
    renderTable(dados);
}

function renderTable(dados) {
    const tbody = document.getElementById('reports-tbody');
    tbody.innerHTML = '';
    if (dados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">Nenhum agendamento encontrado para os filtros aplicados.</td></tr>';
        return;
    }
    dados.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDateToBR(item.data)}</td>
            <td>${item.horario}</td>
            <td>${item.colaborador}</td>
            <td>${item.nome}</td>
            <td>${item.empreendimento}</td>
            <td>${item.local}</td>
            <td>${item.telefone || '-'}</td>
            <td>${item.observacoes || '-'}</td>
            <td>
                <button class="action-btn" onclick="removeAgendamento('${item.colaborador}_${item.data}_${item.horario}')">
                    Excluir
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function updateStats() {
    const dados = await DataManager.getAllAgendamentosArray();
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    let startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
    startOfWeek.setHours(0, 0, 0, 0);

    let endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    endOfWeek.setHours(23, 59, 59, 999);
    
    const totalAgendamentos = dados.length;
    const agendamentosHoje = dados.filter(item => item.data === todayStr).length;
    const agendamentosSemana = dados.filter(item => {
        const itemDate = new Date(item.data + "T00:00:00");
        return itemDate >= startOfWeek && itemDate <= endOfWeek;
    }).length;

    const agendamentosPorColaborador = dados.reduce((acc, item) => {
        acc[item.colaborador] = (acc[item.colaborador] || 0) + 1;
        return acc;
    }, {});

    const statsContainer = document.getElementById('stats-container');
    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${totalAgendamentos}</div>
            <div class="stat-label">Total Agendados</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${agendamentosHoje}</div>
            <div class="stat-label">Agendamentos Hoje</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${agendamentosSemana}</div>
            <div class="stat-label">Esta Semana (Seg-Dom)</div>
        </div>
    `;
    Object.entries(agendamentosPorColaborador).forEach(([colaborador, count]) => {
        const statCard = document.createElement('div');
        statCard.className = 'stat-card';
        statCard.innerHTML = `
            <div class="stat-number">${count}</div>
            <div class="stat-label">${colaborador}</div>
        `;
        statsContainer.appendChild(statCard);
    });
      if (Object.keys(agendamentosPorColaborador).length === 0 && totalAgendamentos > 0) {
        statsContainer.innerHTML += `<div class="stat-card"><div class="stat-label">Nenhum colaborador com agendamentos.</div></div>`;
    }
}

async function removeAgendamento(key) {
    if (confirm('Tem certeza que deseja excluir este agendamento?')) {
        await DataManager.removeAgendamento(key);
        await new Promise(resolve => setTimeout(resolve, 1500));
        currentAgendamentos = await DataManager.getAgendamentos();
        await loadReports();
        alert('Agendamento excluído com sucesso!');
    }
}

async function clearAllData() {
    await DataManager.clearAllData();
    currentAgendamentos = await DataManager.getAgendamentos();
    await loadReports();
    resetAgendamentoView();
}

async function exportToCSV() {
    const dados = await DataManager.getAllAgendamentosArray();
    if (dados.length === 0) {
        alert('Não há dados para exportar!');
        return;
    }
    const headers = ['Colaborador', 'Nome Responsável', 'Empreendimento', 'Local', 'Data', 'Horário', 'Telefone', 'Observações'];
    
    const csvContent = [
        headers.join(','),
        ...dados.map(item => [
            `"${item.colaborador}"`,
            `"${item.nome}"`,
            `"${item.empreendimento}"`,
            `"${item.local}"`,
            formatDateToBR(item.data),
            item.horario,
            `"${item.telefone || ''}"`,
            `"${(item.observacoes || '').replace(/"/g, '""')}"`
        ].join(','))
    ].join('\n');

    downloadFile(csvContent, 'agendamentos_vistorias.csv', 'text/csv;charset=utf-8;');
}

function exportToPDF() {
    alert('Funcionalidade de exportação para PDF ainda não implementada. Considere usar a impressão do navegador (Ctrl+P) e "Salvar como PDF" ou uma biblioteca como jsPDF para uma solução mais robusta.');
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function formatDateToBR(dateStr) {
    if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
}

document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>
