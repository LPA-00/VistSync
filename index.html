<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema de Agendamento de Vistorias</title>
    <style>
        :root {
            --verde-principal: rgb(52, 69, 55);
            --verde-claro: rgb(72, 95, 75);
            --branco: #f5f5f5;
            --cinza: #e0e0e0;
            --vermelho: #e74c3c;
            --azul: #3498db;
            --azul-claro: #87CEEB; /* Novo: para horário selecionado */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; } /* Added asterisk for global reset */
        body {
          background-color: var(--branco);
          font-family: Arial, sans-serif;
          color: var(--verde-principal);
          padding: 20px;
        }
        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
          padding: 0 20px;
          flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        .header h1 {
            margin-bottom: 10px; /* Adjust margin for h1 in header */
        }
        .nav-buttons {
          display: flex;
          gap: 10px;
        }
        .nav-btn {
          background-color: var(--azul);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
        .nav-btn:hover {
          background-color: #2980b9;
        }
        .nav-btn.active {
          background-color: var(--verde-principal);
        }
        h1, h2 { text-align: center; margin-bottom: 20px; }
        .card-container {
          display: flex;
          justify-content: center;
          gap: 20px;
          flex-wrap: wrap;
        }
        .card {
          background-color: var(--verde-principal);
          color: var(--branco);
          padding: 20px;
          border-radius: 12px;
          cursor: pointer;
          width: 180px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          transition: transform 0.3s;
        }
        .card:hover { transform: scale(1.05); }
        .hidden { display: none !important; } /* Added !important for stronger override */
        .selector, .back-button, .confirm-button-container { margin-top: 20px; text-align: center; } /* Adicionado .confirm-button-container */
        .selector button, .back-button button, .confirm-button-container button {
          background-color: var(--verde-claro);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          margin: 5px;
        }
        .selector button:hover, .back-button button:hover, .confirm-button-container button:hover {
          background-color: var(--verde-principal);
        }
        .calendar-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 10px;
          max-width: 700px; /* Limit calendar width */
          margin: 0 auto; /* Center calendar */
        }
        .header-cell {
          font-weight: bold;
          text-align: center;
          padding: 10px 0;
        }
        .day-card {
          background-color: var(--cinza);
          padding: 15px;
          border-radius: 8px;
          cursor: pointer;
          text-align: center;
          position: relative;
          min-height: 50px; /* Ensure consistent height */
          display: flex; /* For centering content */
          align-items: center; /* For centering content */
          justify-content: center; /* For centering content */
        }
        .day-card:hover {
          background-color: var(--verde-claro);
          color: white;
        }
        .icon-red {
          color: var(--vermelho);
          position: absolute;
          top: 5px;
          right: 5px;
          font-size: 18px;
        }
        .day-hours-container { /* Wrapper for day hours for better layout */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .hour {
          background-color: var(--cinza);
          padding: 10px;
          border-radius: 8px;
          cursor: pointer;
          text-align: center;
          margin: 5px;
          min-width: 80px;
        }
        /* Novos estilos para seleção */
        .hour.booked { /* Estilo para horários já agendados */
            background-color: var(--vermelho);
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .hour.selected { /* Estilo para horários SELECIONADOS */
            background-color: var(--azul); /* Azul claro para indicar seleção */
            color: white;
            border: 2px solid var(--verde-principal);
        }
        /* Garante que o hover funcione apenas para não-agendados e não-selecionados */
        .hour:not(.booked):not(.selected):hover { 
          background-color: var(--verde-claro);
          color: white;
        }
        .form {
          margin-top: 20px;
          display: none; /* Initially hidden, controlled by JS */
          flex-direction: column;
          gap: 10px;
          max-width: 400px;
          margin-left: auto;
          margin-right: auto;
          background-color: var(--cinza);
          padding: 20px;
          border-radius: 12px;
        }
        .form input, .form textarea {
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 6px;
          font-family: inherit;
        }
        .form button {
          background-color: var(--verde-principal);
          color: white;
          border: none;
          padding: 10px;
          border-radius: 8px;
          cursor: pointer;
        }
        .form button:hover {
          background-color: var(--verde-claro);
        }
        .form button[type="button"] { /* Style for cancel button */
            background-color: var(--vermelho);
        }
        .form button[type="button"]:hover {
            background-color: #c0392b;
        }
        .no-available {
          color: var(--vermelho);
          text-align: center;
          margin-top: 10px;
          font-style: italic;
        }
        .week-grid {
          display: grid;
          grid-template-columns: repeat(5, 1fr); /* Mon-Fri */
          gap: 10px;
          margin-top: 20px;
          max-width: 800px; /* Limit width */
          margin-left: auto;
          margin-right: auto;
        }
        .week-grid > div { /* Column in week grid */
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--cinza);
        }
        /* Estilos para relatórios */
        .report-container {
          max-width: 1200px;
          margin: 0 auto;
        }
        .filter-section {
          background-color: var(--cinza);
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 20px;
        }
        .filter-row {
          display: flex;
          gap: 15px;
          margin-bottom: 15px;
          flex-wrap: wrap;
          align-items: end;
        }
        .filter-group {
          display: flex;
          flex-direction: column;
          gap: 5px;
        }
        .filter-group label {
          font-weight: bold;
          font-size: 14px;
        }
        .filter-group input, .filter-group select {
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 6px;
          min-width: 150px;
        }
        .export-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin: 20px 0;
        }
        .export-btn {
          background-color: var(--azul);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        }
        .export-btn:hover {
          background-color: #2980b9;
        }
        .export-btn[style*="background-color: var(--vermelho);"]:hover {
            background-color: #c0392b !important;
        }
        .table-container {
          overflow-x: auto;
          background-color: white;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        table {
          width: 100%;
          border-collapse: collapse;
        }
        th, td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #ddd;
        }
        th {
          background-color: var(--verde-principal);
          color: white;
          font-weight: bold;
          position: sticky; /* Make table headers sticky */
          top: 0;
        }
        tr:hover {
          background-color: #f8f9fa;
        }
        .status-badge {
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: bold;
        }
        .status-agendado {
          background-color: #e8f5e8;
          color: #2d5016;
        }
        .action-btn {
          background-color: var(--vermelho);
          color: white;
          border: none;
          padding: 5px 10px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }
        .action-btn:hover {
          background-color: #c0392b;
        }
        .stats-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }
        .stat-card {
          background-color: white;
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-number {
          font-size: 2em;
          font-weight: bold;
          color: var(--verde-principal);
        }
        .stat-label {
          color: #666;
          margin-top: 5px;
        }
        /* Estilos para o popup de adicionar colaborador */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }
        .modal-content input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .modal-content button {
            background-color: var(--verde-principal);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .modal-content button:hover {
            background-color: var(--verde-claro);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sistema de Agendamento de Vistorias</h1>
        <div class="nav-buttons">
            <button class="nav-btn active" id="btn-agendar" onclick="showSection('agendamento')">Agendar</button>
            <button class="nav-btn" id="btn-relatorios" onclick="showSection('relatorios')">Relatórios</button>
        </div>
    </div>
    <div id="section-agendamento">
        <div class="card-container" id="collaborators">
            <div class="card" onclick="selectCollaborator('Cleber')">Cleber</div>
            <div class="card" onclick="selectCollaborator('Devilson')">Devilson</div>
            <div class="card" style="background-color: var(--azul); cursor: pointer;" onclick="openAddCollaboratorModal()">
                + Adicionar Colaborador
            </div>
        </div>
        <div class="selector hidden" id="selector">
            <h2 id="selectedCollaborator"></h2>
            <button onclick="showWeek()">Próximos 5 Dias Úteis</button>
            <button onclick="showMonth()">Visualização Mensal</button>
        </div>
        <div class="back-button hidden" id="backButton">
            <button onclick="goBack()">⬅ Voltar</button>
        </div>
        <div class="confirm-button-container hidden" id="confirmButtonContainer">
            <button onclick="confirmSelectedHours()">Confirmar Horários Selecionados</button>
        </div>
        <div class="calendar hidden" id="calendar">
            </div>
        <div class="day-hours hidden" id="dayHours">
             </div>
        <div class="week-view hidden" id="weekView">
            </div>
        <div class="form" id="form">
            <h3>Detalhes do Agendamento</h3>
            <p>Você está agendando para: <span id="summaryCollaborator"></span> em <span id="summaryDate"></span> às <span id="summaryHours"></span></p>
            <input type="text" id="nome" placeholder="Nome do responsável *" required>
            <input type="text" id="empreendimento" placeholder="Empreendimento *" required>
            <input type="text" id="local" placeholder="Local (Ex: Ap 101) *" required>
            <input type="tel" id="telefone" placeholder="Telefone">
            <textarea id="observacoes" placeholder="Observações (opcional)" rows="3"></textarea>
            <button onclick="book()">Agendar</button>
            <button type="button" onclick="cancelForm()">Cancelar</button>
        </div>
    </div>
    <div id="section-relatorios" class="hidden">
        <div class="report-container">
            <div class="filter-section">
                <h3>Filtros</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filter-colaborador">Colaborador:</label>
                        <select id="filter-colaborador">
                            <option value="">Todos</option>
                            <option value="Cleber">Cleber</option>
                            <option value="Devilson">Devilson</option>
                            </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-inicio">Data Inicial:</label>
                        <input type="date" id="filter-data-inicio">
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-fim">Data Final:</label>
                        <input type="date" id="filter-data-fim">
                    </div>
                    <div class="filter-group">
                        <label for="filter-empreendimento">Empreendimento:</label>
                        <input type="text" id="filter-empreendimento" placeholder="Filtrar por empreendimento">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="nav-btn" onclick="applyFilters()">Filtrar</button>
                    </div>
                </div>
            </div>
            <div class="stats-container" id="stats-container">
                </div>
            <div class="export-buttons">
                <button class="export-btn" onclick="exportToCSV()">Exportar CSV</button>
                <button class="export-btn" onclick="exportToPDF()">Exportar PDF</button>
                <button class="export-btn" style="background-color: var(--vermelho);" onclick="clearAllData()">Limpar Todos os Dados</button>
            </div>
            <div class="table-container">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Colaborador</th>
                            <th>Responsável</th>
                            <th>Empreendimento</th>
                            <th>Local</th>
                            <th>Telefone</th>
                            <th>Observações</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="addCollaboratorModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAddCollaboratorModal()">&times;</span>
            <h2>Adicionar Novo Colaborador</h2>
            <input type="text" id="newCollaboratorName" placeholder="Nome do Colaborador" required>
            <button onclick="addCollaborator()">Adicionar</button>
            <button onclick="closeAddCollaboratorModal()">Cancelar</button>
        </div>
    </div>

<script>
const horarios = ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
let currentAgendamentos = {}; // Agora é um objeto para fácil lookup por chave
let selectedCollaborator = '';
let selectedDate = ''; // Format: YYYY-MM-DD
let selectedHoursSlots = []; // NOVO: Armazena { date: 'YYYY-MM-DD', hour: 'HH:MM' } de horários selecionados

// --- DataManager usando Google Sheets ---
// URL do seu Google Apps Script publicado como Web App
// ATENÇÃO: SUBSTITUA ESTE URL PELO SEU WEB APP PUBLICADO
const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzAUEEKLGCEUq4meIjEiB90hafocMbgwxUVsATNonvBDarXOwl4TMsZNIDwgC5SeZzO/exec';

class DataManager {
    static async getAgendamentos() {
        try {
            const res = await fetch(GOOGLE_SHEET_API_URL);
            if (!res.ok) {
                const errorText = await res.text();
                console.error('Erro na resposta do fetch:', res.status, errorText);
                throw new Error(`HTTP error! status: ${res.status} - ${errorText}`);
            }
            const agendamentosArray = await res.json();
            // Converte o array retornado pelo Apps Script em um objeto para fácil lookup
            const agendamentosMap = {};
            agendamentosArray.forEach(ag => {
                const key = `${ag.colaborador}_${ag.data}_${ag.hora}`;
                agendamentosMap[key] = ag;
            });
            return agendamentosMap || {};
        } catch (error) {
            console.error('Erro ao buscar agendamentos:', error);
            alert('Erro ao carregar agendamentos. Verifique a URL do Google Apps Script ou as permissões no console do navegador.');
            return {};
        }
    }

    static async addAgendamento(dataToSend) {
        try {
            const res = await fetch(GOOGLE_SHEET_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend) 
            });
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ message: res.statusText }));
                throw new Error(`HTTP error! Status: ${res.status}, Message: ${errorData.message || 'Unknown error'}`);
            }
            const responseBody = await res.json();
            if (responseBody.success === false && responseBody.message) {
                 throw new Error(responseBody.message); 
            }
            return true; 
        } catch (err) {
            console.error('Erro ao enviar agendamento para Google Sheets:', err);
            alert('Falha ao agendar. Detalhes: ' + err.message);
            return false; 
        }
    }

    static async removeAgendamento(key) {
        // Esta função precisaria de uma implementação no Apps Script
        alert('A remoção de agendamentos ainda não está implementada via API. Por favor, remova diretamente na planilha se necessário.');
    }

    static async getAllAgendamentosArray() {
        const agendamentosMap = await this.getAgendamentos();
        const agendamentosArray = Object.values(agendamentosMap); // Converte o mapa de volta para um array de valores
        
        return agendamentosArray
            .map(item => ({
                key: `${item.colaborador}_${item.data}_${item.hora}`, 
                colaborador: item.colaborador,
                data: item.data, 
                horario: item.hora, 
                nome: item.nome, 
                empreendimento: item.empreendimento,
                local: item.local,
                telefone: item.telefone,
                observacoes: item.observacoes
            }))
            .sort((a, b) => {
                const dateA = new Date(`${a.data}T${a.horario}`);
                const dateB = new Date(`${b.data}T${b.horario}`);
                return dateA - dateB;
            });
    }

    static async clearAllData() {
        alert('Limpar todos os dados é uma operação crítica e DEVE ser implementada no Google Apps Script com devida segurança, não diretamente no frontend.');
    }
}

// NOVO: Lista de colaboradores persistente apenas no frontend por agora
let collaboratorsList = ['Cleber', 'Devilson']; 

async function initializeApp() {
    await loadCollaborators(); // Carrega colaboradores na UI e nos filtros
    currentAgendamentos = await DataManager.getAgendamentos(); 
    const today = new Date().toISOString().split('T')[0];
    const dataInicioFilter = document.getElementById('filter-data-inicio');
    const dataFimFilter = document.getElementById('filter-data-fim');
    if (!dataInicioFilter.value) dataInicioFilter.value = today;
    if (!dataFimFilter.value) dataFimFilter.value = today;
    
    showSection('agendamento'); 
}

async function loadCollaborators() {
    const collaboratorsContainer = document.getElementById('collaborators');
    collaboratorsContainer.innerHTML = ''; // Limpa os cards existentes

    collaboratorsList.forEach(collab => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerText = collab;
        card.onclick = () => selectCollaborator(collab);
        collaboratorsContainer.appendChild(card);
    });

    // Adiciona o botão "Adicionar Colaborador" por último
    const addCollabCard = document.createElement('div');
    addCollabCard.className = 'card';
    addCollabCard.style.backgroundColor = 'var(--azul)';
    addCollabCard.style.cursor = 'pointer';
    addCollabCard.innerText = '+ Adicionar Colaborador';
    addCollabCard.onclick = openAddCollaboratorModal;
    collaboratorsContainer.appendChild(addCollabCard);

    // Atualiza o select de filtro de colaborador nos relatórios
    const filterColaboradorSelect = document.getElementById('filter-colaborador');
    filterColaboradorSelect.innerHTML = '<option value="">Todos</option>';
    collaboratorsList.forEach(collab => {
        const option = document.createElement('option');
        option.value = collab;
        option.innerText = collab;
        filterColaboradorSelect.appendChild(option);
    });
}

function openAddCollaboratorModal() {
    document.getElementById('addCollaboratorModal').style.display = 'block';
    document.getElementById('newCollaboratorName').value = ''; // Limpa o campo
    document.getElementById('newCollaboratorName').focus();
}

function closeAddCollaboratorModal() {
    document.getElementById('addCollaboratorModal').style.display = 'none';
}

function addCollaborator() {
    const newName = document.getElementById('newCollaboratorName').value.trim();
    if (newName && !collaboratorsList.includes(newName)) {
        collaboratorsList.push(newName);
        loadCollaborators(); // Recarrega os cartões de colaboradores
        closeAddCollaboratorModal();
        alert(`Colaborador "${newName}" adicionado!`);
    } else if (newName) {
        alert(`"${newName}" já existe na lista de colaboradores.`);
    } else {
        alert('Por favor, digite um nome para o colaborador.');
    }
}


async function showSection(section) {
    document.getElementById('section-agendamento').classList.add('hidden');
    document.getElementById('section-relatorios').classList.add('hidden');
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

    const targetSectionId = `section-${section}`;
    const targetButtonId = `btn-${section === 'agendamento' ? 'agendar' : 'relatorios'}`;

    document.getElementById(targetSectionId).classList.remove('hidden');
    document.getElementById(targetButtonId).classList.add('active');

    if (section === 'relatorios') {
        await loadReports();
    } else {
        // Sempre busca agendamentos atualizados ao voltar para a seção de agendamento
        currentAgendamentos = await DataManager.getAgendamentos(); 
        resetAgendamentoView();
    }
}

function resetAgendamentoView() {
    clearScreensAndForm();
    document.getElementById('collaborators').classList.remove('hidden');
    document.getElementById('selector').classList.add('hidden');
    document.getElementById('backButton').classList.add('hidden');
    document.getElementById('confirmButtonContainer').classList.add('hidden'); // Esconde o botão de confirmar
    selectedCollaborator = '';
    selectedDate = ''; 
    selectedHoursSlots = []; // Limpa os horários selecionados
}

function selectCollaborator(nome) {
    selectedCollaborator = nome;
    document.getElementById('collaborators').classList.add('hidden');
    document.getElementById('selector').classList.remove('hidden');
    document.getElementById('selectedCollaborator').innerText = `Agendar para: ${nome}`;
    document.getElementById('backButton').classList.remove('hidden'); 
    // Após selecionar o colaborador, podemos ir para a visualização da semana ou mês
    // showWeek(); // Ou showMonth(); se preferir um padrão diferente
}

function goBack() { 
    const form = document.getElementById('form');
    const dayHours = document.getElementById('dayHours');
    const calendar = document.getElementById('calendar');
    const weekView = document.getElementById('weekView');
    const selector = document.getElementById('selector');
    const confirmButtonContainer = document.getElementById('confirmButtonContainer');

    if (form.style.display === 'flex') { 
        // Se o formulário está visível, volte para a seleção de horários
        cancelForm(); 
        if (!weekView.classList.contains('hidden')) { // Se veio da semana
            showWeek();
        } else if (!dayHours.classList.contains('hidden')) { // Se veio do dia
            openDay(selectedDate);
        } else { // Fallback, se não tem certeza de onde veio
            showMonth();
        }
    } else if (!dayHours.classList.contains('hidden')) { 
        // Se horários do dia estão visíveis, volte para o calendário mensal
        showMonth();
    } else if (!calendar.classList.contains('hidden') || !weekView.classList.contains('hidden') || !confirmButtonContainer.classList.contains('hidden')) { 
        // Se calendário, semana ou botão confirmar estão visíveis, volte para o seletor (semana/mês)
        clearScreensAndForm();
        selector.classList.remove('hidden');
        confirmButtonContainer.classList.add('hidden'); // Garante que o botão confirmar esteja oculto
        selectedHoursSlots = []; // Limpa seleção ao voltar
        document.getElementById('backButton').classList.remove('hidden'); 
    } else if (!selector.classList.contains('hidden')) { 
        // Se o seletor está visível, volte para a seleção de colaborador
        resetAgendamentoView();
    }
}

async function showMonth() {
    clearScreensAndForm();
    selectedHoursSlots = []; // Limpa seleção ao mudar de vista
    document.getElementById('confirmButtonContainer').classList.add('hidden'); // Esconde o botão de confirmar
    currentAgendamentos = await DataManager.getAgendamentos(); 

    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = '';
    calendarEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth(); 

    const monthName = today.toLocaleString('pt-BR', { month: 'long' });
    calendarEl.innerHTML = `<h2>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} / ${year}</h2>`;

    const firstDayOfMonth = new Date(year, month, 1).getDay(); 
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const grid = document.createElement('div');
    grid.className = 'calendar-grid';

    const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
    weekDays.forEach(day => grid.innerHTML += `<div class='header-cell'>${day}</div>`);

    for (let i = 0; i < firstDayOfMonth; i++) {
        grid.innerHTML += `<div></div>`; 
    }

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const currentDate = new Date(dateStr + 'T00:00:00'); 
        const todayAtMidnight = new Date(new Date().toISOString().split('T')[0] + 'T00:00:00');

        let hasAvailable = false;
        if (currentDate >= todayAtMidnight) { 
             hasAvailable = horarios.some(h => !currentAgendamentos[`${selectedCollaborator}_${dateStr}_${h}`]);
        }
        
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (currentDate < todayAtMidnight) { 
            dayCard.style.backgroundColor = '#dddddd';
            dayCard.style.cursor = 'not-allowed';
            dayCard.innerHTML = `${d}`;
        } else {
            dayCard.innerHTML = `${hasAvailable ? '' : '<div class="icon-red">🔴</div>'}${d}`;
            dayCard.onclick = () => openDay(dateStr);
        }
        grid.appendChild(dayCard);
    }
    calendarEl.appendChild(grid);
}

async function showWeek() {
    clearScreensAndForm();
    selectedHoursSlots = []; // Limpa seleção ao mudar de vista
    document.getElementById('confirmButtonContainer').classList.add('hidden'); // Esconde o botão de confirmar
    currentAgendamentos = await DataManager.getAgendamentos();

    const weekViewEl = document.getElementById('weekView');
    weekViewEl.innerHTML = '<h2>Próximos 5 Dias Úteis</h2>';
    weekViewEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const today = new Date();
    const weekDates = [];

    let currentDate = new Date(today);
    // Move currentDate forward to the next Monday if it's currently Saturday/Sunday
    if (currentDate.getDay() === 0) { // Sunday
        currentDate.setDate(currentDate.getDate() + 1);
    } else if (currentDate.getDay() === 6) { // Saturday
        currentDate.setDate(currentDate.getDate() + 2);
    }

    for (let i = 0; i < 5; i++) { 
        // Ensure we skip any remaining weekend days if we started on a weekday
        while (currentDate.getDay() === 0 || currentDate.getDay() === 6) { 
            currentDate.setDate(currentDate.getDate() + 1);
        }
        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
        const dayLabel = currentDate.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
        weekDates.push({ label: `${dayLabel} (${currentDate.getDate()}/${currentDate.getMonth()+1})`, dateStr });
        currentDate.setDate(currentDate.getDate() + 1);
    }

    const grid = document.createElement('div');
    grid.className = 'week-grid';

    for (const day of weekDates) { 
        const column = document.createElement('div');
        const header = document.createElement('div');
        header.className = 'header-cell';
        header.innerText = day.label;
        column.appendChild(header);

        let hasAvailableSlotsForDay = false; 
        horarios.forEach(hora => {
            const key = `${selectedCollaborator}_${day.dateStr}_${hora}`;
            const isBooked = currentAgendamentos[key];
            const isSelected = selectedHoursSlots.some(s => s.date === day.dateStr && s.hour === hora);

            const btn = document.createElement('div');
            btn.className = 'hour';
            btn.innerText = hora;
            btn.dataset.date = day.dateStr; // Adiciona data como data attribute
            btn.dataset.hour = hora; // Adiciona hora como data attribute

            if (isBooked) {
                btn.classList.add('booked');
                btn.style.cursor = 'not-allowed';
            } else if (isSelected) {
                btn.classList.add('selected');
                hasAvailableSlotsForDay = true; // Horário selecionado conta como disponível para o dia
                btn.onclick = () => toggleHourSelection(btn); // Permite desselecionar
            } else {
                hasAvailableSlotsForDay = true;
                btn.onclick = () => toggleHourSelection(btn); // Permite selecionar
            }
            column.appendChild(btn);
        });

        if (!hasAvailableSlotsForDay && new Date(day.dateStr + 'T00:00:00') >= new Date(new Date().toISOString().split('T')[0] + 'T00:00:00')) {
            const noAvailable = document.createElement('div');
            noAvailable.className = 'no-available';
            noAvailable.innerHTML = '🔴'; 
            column.appendChild(noAvailable);
        }
        grid.appendChild(column);
    }
    weekViewEl.appendChild(grid);
    if (selectedHoursSlots.length > 0) {
        document.getElementById('confirmButtonContainer').classList.remove('hidden');
    }
}

async function openDay(dateStr) { 
    clearScreensAndForm();
    selectedHoursSlots = []; // Limpa seleção ao mudar de vista
    document.getElementById('confirmButtonContainer').classList.add('hidden'); // Esconde o botão de confirmar
    currentAgendamentos = await DataManager.getAgendamentos();

    const dayHoursEl = document.getElementById('dayHours');
    dayHoursEl.innerHTML = ''; 
    dayHoursEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const formattedDate = formatDateToBR(dateStr);
    dayHoursEl.innerHTML = `<h2>Horários para ${formattedDate}</h2>`;
    
    const container = document.createElement('div'); 
    container.className = 'day-hours-container';

    const currentDate = new Date(dateStr + 'T00:00:00');
    const todayAtMidnight = new Date(new Date().toISOString().split('T')[0] + 'T00:00:00');

    let hasAvailableSlotsForDay = false; 
    if (currentDate < todayAtMidnight) {
         const pastDateMsg = document.createElement('div');
         pastDateMsg.className = 'no-available';
         pastDateMsg.innerText = 'Não é possível agendar em datas passadas.';
         container.appendChild(pastDateMsg);
    } else {
        horarios.forEach(hora => {
            const key = `${selectedCollaborator}_${dateStr}_${hora}`;
            const isBooked = currentAgendamentos[key];
            const isSelected = selectedHoursSlots.some(s => s.date === dateStr && s.hour === hora);

            const hourBtn = document.createElement('div');
            hourBtn.className = 'hour';
            hourBtn.innerText = hora;
            hourBtn.dataset.date = dateStr; // Adiciona data como data attribute
            hourBtn.dataset.hour = hora; // Adiciona hora como data attribute
            
            if (isBooked) {
                hourBtn.classList.add('booked');
                hourBtn.style.cursor = 'not-allowed';
            } else if (isSelected) {
                hourBtn.classList.add('selected');
                hasAvailableSlotsForDay = true;
                hourBtn.onclick = () => toggleHourSelection(hourBtn);
            } else {
                hasAvailableSlotsForDay = true;
                hourBtn.onclick = () => toggleHourSelection(hourBtn);
            }
            container.appendChild(hourBtn);
        });
    }

    if (!hasAvailableSlotsForDay && currentDate >= todayAtMidnight) {
        const noAvailable = document.createElement('div');
        noAvailable.className = 'no-available';
        noAvailable.innerText = '🔴 Sem horários disponíveis para este dia.';
        container.appendChild(noAvailable);
    }
    dayHoursEl.appendChild(container);

    const backBtnDiv = document.createElement('div');
    backBtnDiv.className = 'back-button'; 
    backBtnDiv.style.marginTop = '20px';
    const specificBackBtn = document.createElement('button');
    specificBackBtn.innerHTML = '⬅ Voltar para o Calendário Mensal';
    specificBackBtn.onclick = () => showMonth();
    backBtnDiv.appendChild(specificBackBtn);
    dayHoursEl.appendChild(backBtnDiv);

    if (selectedHoursSlots.length > 0) {
        document.getElementById('confirmButtonContainer').classList.remove('hidden');
    }
}

// NOVO: Função para alternar a seleção de horários
function toggleHourSelection(element) {
    if (element.classList.contains('booked')) {
        return; // Não permite selecionar horários já agendados
    }

    const date = element.dataset.date;
    const hour = element.dataset.hour;
    const slot = { date, hour };

    const index = selectedHoursSlots.findIndex(s => s.date === date && s.hour === hour);

    if (index > -1) {
        // Já selecionado, então desseleciona
        selectedHoursSlots.splice(index, 1);
        element.classList.remove('selected');
    } else {
        // Não selecionado, então seleciona
        selectedHoursSlots.push(slot);
        element.classList.add('selected');
    }

    // Exibe ou esconde o botão de confirmar baseado na seleção
    if (selectedHoursSlots.length > 0) {
        document.getElementById('confirmButtonContainer').classList.remove('hidden');
    } else {
        document.getElementById('confirmButtonContainer').classList.add('hidden');
    }
}

// NOVO: Função para confirmar os horários selecionados e exibir o formulário
function confirmSelectedHours() {
    if (selectedHoursSlots.length === 0) {
        alert('Por favor, selecione ao menos um horário para agendar.');
        return;
    }

    // Ordena os horários selecionados para uma melhor apresentação
    selectedHoursSlots.sort((a, b) => {
        const dateA = new Date(`${a.date}T${a.hour}`);
        const dateB = new Date(`${b.date}T${b.hour}`);
        return dateA - dateB;
    });

    // Preenche o resumo no formulário
    document.getElementById('summaryCollaborator').innerText = selectedCollaborator;
    const uniqueDates = [...new Set(selectedHoursSlots.map(s => formatDateToBR(s.date)))];
    document.getElementById('summaryDate').innerText = uniqueDates.join(', ');
    const hoursSummary = selectedHoursSlots.map(s => s.hour).join(', ');
    document.getElementById('summaryHours').innerText = hoursSummary;


    document.getElementById('form').style.display = 'flex'; // Mostra o formulário
    document.getElementById('dayHours').classList.add('hidden'); // Esconde o view do dia
    document.getElementById('weekView').classList.add('hidden'); // Esconde o view da semana
    document.getElementById('calendar').classList.add('hidden'); // Esconde o calendário
    document.getElementById('confirmButtonContainer').classList.add('hidden'); // Esconde o botão de confirmar
    document.getElementById('nome').focus();
}


async function book() {
    const nome = document.getElementById('nome').value.trim();
    const empreendimento = document.getElementById('empreendimento').value.trim();
    const local = document.getElementById('local').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const observacoes = document.getElementById('observacoes').value.trim();

    if (!nome || !empreendimento || !local) {
        alert('Preencha os campos obrigatórios: Nome, Empreendimento e Local!');
        return;
    }

    if (selectedHoursSlots.length === 0) {
        alert('Nenhum horário selecionado para agendar. Por favor, volte e selecione.');
        return;
    }

    // Re-checa a disponibilidade antes de agendar (para evitar conflitos entre a seleção e o clique em Agendar)
    currentAgendamentos = await DataManager.getAgendamentos(); 
    let allBookingsSuccessful = true;
    let failedBookings = [];

    for (const slot of selectedHoursSlots) {
        const keyToCheck = `${selectedCollaborator}_${slot.date}_${slot.hour}`;
        if (currentAgendamentos[keyToCheck]) {
            alert(`O horário de ${slot.hour} em ${formatDateToBR(slot.date)} já foi agendado por outra pessoa. Por favor, remova-o da seleção.`);
            allBookingsSuccessful = false;
            failedBookings.push(slot);
            continue; // Pula este slot e tenta os próximos
        }

        const agendamentoData = {
            colaborador: selectedCollaborator, 
            nome: nome,
            empreendimento: empreendimento,
            local: local,
            telefone: telefone,
            observacoes: observacoes,
            dataAgendada: slot.date,   
            horaAgendada: slot.hour
        };

        const success = await DataManager.addAgendamento(agendamentoData); 
        if (!success) {
            allBookingsSuccessful = false;
            failedBookings.push(slot);
            // Mensagem de erro já é tratada dentro de DataManager.addAgendamento
        }
    }
    
    if (allBookingsSuccessful) {
        alert(`Agendamento(s) para ${selectedCollaborator} em ${selectedHoursSlots.map(s => `${formatDateToBR(s.date)} às ${s.hour}`).join(', ')} realizado(s) com sucesso!`);
    } else {
        let failureMessage = 'Alguns agendamentos falharam:\n';
        failedBookings.forEach(slot => {
            failureMessage += `- ${formatDateToBR(slot.date)} às ${slot.hour}\n`;
        });
        failureMessage += '\nVerifique o console para mais detalhes ou tente novamente.';
        alert(failureMessage);
    }

    clearForm();
    resetAgendamentoView(); 
}

function clearForm() {
    const form = document.getElementById('form');
    form.style.display = 'none';
    document.getElementById('nome').value = '';
    document.getElementById('empreendimento').value = '';
    document.getElementById('local').value = '';
    document.getElementById('telefone').value = '';
    document.getElementById('observacoes').value = '';
}

function cancelForm() {
    clearForm();
    // Volte para a visualização anterior (dia ou semana) mantendo a seleção
    if(selectedHoursSlots.length > 0) { // Se havia horários selecionados, volte para a seleção
        document.getElementById('confirmButtonContainer').classList.remove('hidden');
        if (!document.getElementById('weekView').classList.contains('hidden')) {
            showWeek(); // Re-renderiza para mostrar os selecionados
        } else if (selectedDate) {
            openDay(selectedDate); // Re-renderiza para mostrar os selecionados
        } else { // Fallback, se não tem certeza de onde veio
            showMonth();
        }
    } else { // Se não havia horários selecionados, volte ao fluxo normal
       goBack(); 
    }
}

function clearScreensAndForm() {
    document.getElementById('calendar').classList.add('hidden');
    document.getElementById('dayHours').classList.add('hidden');
    document.getElementById('weekView').classList.add('hidden');
    document.getElementById('form').style.display = 'none'; // Garante que o formulário está oculto
}

// --- Funções de Relatório ---
async function loadReports() {
    await applyFilters(); 
    await updateStats();
}

async function applyFilters() {
    const colaboradorFilter = document.getElementById('filter-colaborador').value;
    let dataInicioFilter = document.getElementById('filter-data-inicio').value;
    let dataFimFilter = document.getElementById('filter-data-fim').value;
    const empreendimentoFilter = document.getElementById('filter-empreendimento').value.toLowerCase();

    // Use getAllAgendamentosArray para obter os dados já formatados e em array
    let dados = await DataManager.getAllAgendamentosArray(); 

    dataInicioFilter = dataInicioFilter ? new Date(dataInicioFilter + 'T00:00:00Z') : null;
    dataFimFilter = dataFimFilter ? new Date(dataFimFilter + 'T00:00:00Z') : null;

    if (colaboradorFilter) {
        dados = dados.filter(item => item.colaborador === colaboradorFilter);
    }
    if (dataInicioFilter) {
        dados = dados.filter(item => new Date(item.data + 'T00:00:00Z') >= dataInicioFilter);
    }
    if (dataFimFilter) {
        dados = dados.filter(item => new Date(item.data + 'T00:00:00Z') <= dataFimFilter);
    }
    if (empreendimentoFilter) {
        dados = dados.filter(item => item.empreendimento.toLowerCase().includes(empreendimentoFilter));
    }
    renderTable(dados);
}

function renderTable(dados) {
    const tbody = document.getElementById('reports-tbody');
    tbody.innerHTML = '';

    if (dados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">Nenhum agendamento encontrado para os filtros aplicados.</td></tr>';
        return;
    }

    dados.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDateToBR(item.data)}</td>
            <td>${item.horario}</td>
            <td>${item.colaborador}</td>
            <td>${item.nome}</td>
            <td>${item.empreendimento}</td>
            <td>${item.local}</td>
            <td>${item.telefone || '-'}</td>
            <td>${item.observacoes || '-'}</td>
            <td>
                <button class="action-btn" onclick="removeAgendamento('${item.key}')">
                    Excluir
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function updateStats() {
    const dados = await DataManager.getAllAgendamentosArray(); 
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0]; 

    let startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); 
    startOfWeek.setHours(0, 0, 0, 0);

    let endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6); 
    endOfWeek.setHours(23, 59, 59, 999);
    
    const totalAgendamentos = dados.length;
    const agendamentosHoje = dados.filter(item => item.data === todayStr).length;
    const agendamentosSemana = dados.filter(item => {
        const itemDate = new Date(item.data + "T00:00:00"); 
        return itemDate >= startOfWeek && itemDate <= endOfWeek;
    }).length;

    const agendamentosPorColaborador = dados.reduce((acc, item) => {
        acc[item.colaborador] = (acc[item.colaborador] || 0) + 1;
        return acc;
    }, {});

    const statsContainer = document.getElementById('stats-container');
    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${totalAgendamentos}</div>
            <div class="stat-label">Total Agendados</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${agendamentosHoje}</div>
            <div class="stat-label">Agendamentos Hoje</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${agendamentosSemana}</div>
            <div class="stat-label">Esta Semana (Seg-Dom)</div>
        </div>
    `;
    Object.entries(agendamentosPorColaborador).forEach(([colaborador, count]) => {
        const statCard = document.createElement('div');
        statCard.className = 'stat-card';
        statCard.innerHTML = `
            <div class="stat-number">${count}</div>
            <div class="stat-label">${colaborador}</div>
        `;
        statsContainer.appendChild(statCard);
    });
     if (Object.keys(agendamentosPorColaborador).length === 0 && totalAgendamentos > 0) {
        statsContainer.innerHTML += `<div class="stat-card"><div class="stat-label">Nenhum colaborador com agendamentos.</div></div>`;
    }
}

async function removeAgendamento(key) {
    if (confirm('Tem certeza que deseja excluir este agendamento? Esta ação não pode ser desfeita e requer funcionalidade no Google Apps Script.')) {
        await DataManager.removeAgendamento(key); 
        await loadReports(); 
    }
}

async function exportToCSV() {
    const dados = await DataManager.getAllAgendamentosArray(); 
    if (dados.length === 0) {
        alert('Não há dados para exportar!');
        return;
    }
    const headers = ['Colaborador', 'Nome Responsável', 'Empreendimento', 'Local', 'Data', 'Horário', 'Telefone', 'Observações'];
    
    const csvContent = [
        headers.join(','),
        ...dados.map(item => [
            `"${item.colaborador}"`,
            `"${item.nome}"`,
            `"${item.empreendimento}"`,
            `"${item.local}"`,
            formatDateToBR(item.data),
            item.horario,
            `"${item.telefone || ''}"`,
            `"${(item.observacoes || '').replace(/"/g, '""')}"` 
        ]).join(',')
    ].join('\n');

    downloadFile(csvContent, 'agendamentos_vistorias.csv', 'text/csv;charset=utf-8;');
}

function exportToPDF() {
    alert('Funcionalidade de exportação para PDF ainda não implementada. Considere usar a impressão do navegador (Ctrl+P) e "Salvar como PDF" ou uma biblioteca como jsPDF para uma solução mais robusta.');
}

async function clearAllData() {
    if (confirm('ATENÇÃO: Isto irá solicitar a exclusão de TODOS os agendamentos. Esta é uma operação crítica e requer uma implementação no seu Google Apps Script com devida autenticação e cuidado. Tem certeza?')) {
        await DataManager.clearAllData(); 
        await loadReports();
    }
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function formatDateToBR(dateStr) { 
    if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr; 
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
}

function formatDateToISO(dateStr) { 
    if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return dateStr;
    const [day, month, year] = dateStr.split('/');
    return `${year}-${month}-${day}`;
}

document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>
