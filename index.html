<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema de Agendamento de Vistorias</title>
    <style>
        :root {
            --verde-principal: rgb(52, 69, 55);
            --verde-claro: rgb(72, 95, 75);
            --branco: #f5f5f5;
            --cinza: #e0e0e0;
            --vermelho: #e74c3c;
            --azul: #3498db;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; } /* Added asterisk for global reset */
        body {
          background-color: var(--branco);
          font-family: Arial, sans-serif;
          color: var(--verde-principal);
          padding: 20px;
        }
        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
          padding: 0 20px;
          flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        .header h1 {
            margin-bottom: 10px; /* Adjust margin for h1 in header */
        }
        .nav-buttons {
          display: flex;
          gap: 10px;
        }
        .nav-btn {
          background-color: var(--azul);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
        .nav-btn:hover {
          background-color: #2980b9;
        }
        .nav-btn.active {
          background-color: var(--verde-principal);
        }
        h1, h2 { text-align: center; margin-bottom: 20px; }
        .card-container {
          display: flex;
          justify-content: center;
          gap: 20px;
          flex-wrap: wrap;
        }
        .card {
          background-color: var(--verde-principal);
          color: var(--branco);
          padding: 20px;
          border-radius: 12px;
          cursor: pointer;
          width: 180px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          transition: transform 0.3s;
        }
        .card:hover { transform: scale(1.05); }
        .hidden { display: none !important; } /* Added !important for stronger override */
        .selector, .back-button { margin-top: 20px; text-align: center; }
        .selector button, .back-button button {
          background-color: var(--verde-claro);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          margin: 5px;
        }
        .selector button:hover, .back-button button:hover {
          background-color: var(--verde-principal);
        }
        .calendar-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 10px;
          max-width: 700px; /* Limit calendar width */
          margin: 0 auto; /* Center calendar */
        }
        .header-cell {
          font-weight: bold;
          text-align: center;
          padding: 10px 0;
        }
        .day-card {
          background-color: var(--cinza);
          padding: 15px;
          border-radius: 8px;
          cursor: pointer;
          text-align: center;
          position: relative;
          min-height: 50px; /* Ensure consistent height */
          display: flex; /* For centering content */
          align-items: center; /* For centering content */
          justify-content: center; /* For centering content */
        }
        .day-card:hover {
          background-color: var(--verde-claro);
          color: white;
        }
        .icon-red {
          color: var(--vermelho);
          position: absolute;
          top: 5px;
          right: 5px;
          font-size: 18px;
        }
        .day-hours-container { /* Wrapper for day hours for better layout */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .hour {
          background-color: var(--cinza);
          padding: 10px;
          border-radius: 8px;
          cursor: pointer;
          text-align: center;
          margin: 5px;
          min-width: 80px;
        }
        .hour.booked { /* Estilo para horários já agendados */
            background-color: var(--vermelho);
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .hour:not(.booked):hover {
          background-color: var(--verde-claro);
          color: white;
        }
        .form {
          margin-top: 20px;
          display: none; /* Initially hidden, controlled by JS */
          flex-direction: column;
          gap: 10px;
          max-width: 400px;
          margin-left: auto;
          margin-right: auto;
          background-color: var(--cinza);
          padding: 20px;
          border-radius: 12px;
        }
        .form input, .form textarea {
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 6px;
          font-family: inherit;
        }
        .form button {
          background-color: var(--verde-principal);
          color: white;
          border: none;
          padding: 10px;
          border-radius: 8px;
          cursor: pointer;
        }
        .form button:hover {
          background-color: var(--verde-claro);
        }
        .form button[type="button"] { /* Style for cancel button */
            background-color: var(--vermelho);
        }
        .form button[type="button"]:hover {
            background-color: #c0392b;
        }
        .no-available {
          color: var(--vermelho);
          text-align: center;
          margin-top: 10px;
          font-style: italic;
        }
        .week-grid {
          display: grid;
          grid-template-columns: repeat(5, 1fr); /* Mon-Fri */
          gap: 10px;
          margin-top: 20px;
          max-width: 800px; /* Limit width */
          margin-left: auto;
          margin-right: auto;
        }
        .week-grid > div { /* Column in week grid */
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--cinza);
        }
        /* Estilos para relatórios */
        .report-container {
          max-width: 1200px;
          margin: 0 auto;
        }
        .filter-section {
          background-color: var(--cinza);
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 20px;
        }
        .filter-row {
          display: flex;
          gap: 15px;
          margin-bottom: 15px;
          flex-wrap: wrap;
          align-items: end;
        }
        .filter-group {
          display: flex;
          flex-direction: column;
          gap: 5px;
        }
        .filter-group label {
          font-weight: bold;
          font-size: 14px;
        }
        .filter-group input, .filter-group select {
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 6px;
          min-width: 150px;
        }
        .export-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin: 20px 0;
        }
        .export-btn {
          background-color: var(--azul);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        }
        .export-btn:hover {
          background-color: #2980b9;
        }
        .export-btn[style*="background-color: var(--vermelho);"]:hover {
            background-color: #c0392b !important;
        }
        .table-container {
          overflow-x: auto;
          background-color: white;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        table {
          width: 100%;
          border-collapse: collapse;
        }
        th, td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #ddd;
        }
        th {
          background-color: var(--verde-principal);
          color: white;
          font-weight: bold;
          position: sticky; /* Make table headers sticky */
          top: 0;
        }
        tr:hover {
          background-color: #f8f9fa;
        }
        .status-badge {
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: bold;
        }
        .status-agendado {
          background-color: #e8f5e8;
          color: #2d5016;
        }
        .action-btn {
          background-color: var(--vermelho);
          color: white;
          border: none;
          padding: 5px 10px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }
        .action-btn:hover {
          background-color: #c0392b;
        }
        .stats-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }
        .stat-card {
          background-color: white;
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-number {
          font-size: 2em;
          font-weight: bold;
          color: var(--verde-principal);
        }
        .stat-label {
          color: #666;
          margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sistema de Agendamento de Vistorias</h1>
        <div class="nav-buttons">
            <button class="nav-btn active" id="btn-agendar" onclick="showSection('agendamento')">Agendar</button>
            <button class="nav-btn" id="btn-relatorios" onclick="showSection('relatorios')">Relatórios</button>
        </div>
    </div>
    <div id="section-agendamento">
        <div class="card-container" id="collaborators">
            <div class="card" onclick="selectCollaborator('Cleber')">Cleber</div>
            <div class="card" onclick="selectCollaborator('Devilson')">Devilson</div>
            </div>
        <div class="selector hidden" id="selector">
            <h2 id="selectedCollaborator"></h2>
            <button onclick="showWeek()">Semana</button>
            <button onclick="showMonth()">Mês</button>
        </div>
        <div class="back-button hidden" id="backButton">
            <button onclick="goBack()">⬅ Voltar</button>
        </div>
        <div class="calendar hidden" id="calendar">
            </div>
        <div class="day-hours hidden" id="dayHours">
             </div>
        <div class="week-view hidden" id="weekView">
            </div>
        <div class="form" id="form">
            <h3>Detalhes do Agendamento</h3>
            <input type="text" id="nome" placeholder="Nome do responsável *" required>
            <input type="text" id="empreendimento" placeholder="Empreendimento *" required>
            <input type="text" id="local" placeholder="Local (Ex: Ap 101) *" required>
            <input type="tel" id="telefone" placeholder="Telefone">
            <textarea id="observacoes" placeholder="Observações (opcional)" rows="3"></textarea>
            <button onclick="book()">Agendar</button>
            <button type="button" onclick="cancelForm()">Cancelar</button>
        </div>
    </div>
    <div id="section-relatorios" class="hidden">
        <div class="report-container">
            <div class="filter-section">
                <h3>Filtros</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filter-colaborador">Colaborador:</label>
                        <select id="filter-colaborador">
                            <option value="">Todos</option>
                            <option value="Cleber">Cleber</option>
                            <option value="Devilson">Devilson</option>
                            </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-inicio">Data Inicial:</label>
                        <input type="date" id="filter-data-inicio">
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-fim">Data Final:</label>
                        <input type="date" id="filter-data-fim">
                    </div>
                    <div class="filter-group">
                        <label for="filter-empreendimento">Empreendimento:</label>
                        <input type="text" id="filter-empreendimento" placeholder="Filtrar por empreendimento">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="nav-btn" onclick="applyFilters()">Filtrar</button>
                    </div>
                </div>
            </div>
            <div class="stats-container" id="stats-container">
                </div>
            <div class="export-buttons">
                <button class="export-btn" onclick="exportToCSV()">Exportar CSV</button>
                <button class="export-btn" onclick="exportToPDF()">Exportar PDF</button>
                <button class="export-btn" style="background-color: var(--vermelho);" onclick="clearAllData()">Limpar Todos os Dados</button>
            </div>
            <div class="table-container">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Colaborador</th>
                            <th>Responsável</th>
                            <th>Empreendimento</th>
                            <th>Local</th>
                            <th>Telefone</th>
                            <th>Observações</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
<script>
const horarios = ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
let currentAgendamentos = []; // Agora é um array, pois virá direto da planilha
let selectedCollaborator = '';
let selectedDate = ''; // Format: YYYY-MM-DD
let selectedHour = '';

// --- DataManager usando Google Sheets ---
// URL do seu Google Apps Script publicado como Web App
// ATENÇÃO: SUBSTITUA ESTE URL PELO SEU WEB APP PUBLICADO
const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxV2A_qpaQI-poWILS35lZGU9d4ClnhWrW1FVvBWHNnFlmzLlQ1l8_RjslQss1K_gYFxw/exec';

class DataManager {
    static async getAgendamentos() {
        try {
            const res = await fetch(GOOGLE_SHEET_API_URL);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const data = await res.json();
            return data.data || []; // A API do Apps Script geralmente retorna um objeto com uma chave 'data'
        } catch (error) {
            console.error('Erro ao buscar agendamentos:', error);
            alert('Erro ao carregar agendamentos. Verifique a URL do Google Apps Script ou as permissões.');
            return [];
        }
    }

    static async addAgendamento(data) {
        try {
            // Removido mode: 'no-cors' para permitir o envio de 'Content-Type'
            // O Google Apps Script Web App geralmente lida com CORS.
            const res = await fetch(GOOGLE_SHEET_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            if (!res.ok) {
                // Tentativa de ler o erro da resposta se o servidor enviar JSON
                const errorData = await res.json().catch(() => ({ message: res.statusText }));
                throw new Error(`HTTP error! Status: ${res.status}, Message: ${errorData.message || 'Unknown error'}`);
            }
            // Após adicionar, recarrega os agendamentos para manter o cache atualizado
            currentAgendamentos = await this.getAllAgendamentosArray(); // Atualiza o cache global
        } catch (err) {
            console.error('Erro ao enviar agendamento para Google Sheets:', err);
            alert('Falha ao agendar. Verifique a conexão ou o Google Apps Script. Detalhes: ' + err.message);
        }
    }

    static async removeAgendamento(key) {
        // Para uma implementação real, esta função precisaria enviar uma requisição
        // ao seu Google Apps Script para remover a linha correspondente ao 'key'.
        // O key seria idealmente o índice da linha ou um ID único da planilha.
        // Como o `key` é ${item.Colaborador}_${item.Data}_${item.Hora}, não é um ID de linha direto.
        // Você precisaria enviar os componentes do key (colaborador, data, hora) para o Apps Script
        // e ele faria a busca e exclusão.
        alert('A remoção de agendamentos ainda não está implementada via API. Por favor, remova diretamente na planilha se necessário.');
        // Exemplo de como poderia ser, exigindo modificação no Apps Script:
        /*
        try {
            const [colaborador, data, hora] = key.split('_');
            const res = await fetch(GOOGLE_SHEET_API_URL, {
                method: 'POST', // Ou um método DELETE customizado no Apps Script
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete', colaborador, data, hora })
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            currentAgendamentos = await this.getAllAgendamentosArray(); // Atualiza cache
        } catch (err) {
            console.error('Erro ao remover agendamento:', err);
            alert('Falha ao remover agendamento. Verifique o Google Apps Script.');
        }
        */
    }

    static async getAllAgendamentosArray() {
        const dados = await this.getAgendamentos();
        // Mapeia os nomes das colunas da planilha para os nomes usados no JS
        return dados
            .map(item => ({
                // Cria uma chave única para identificação, essencial para verificar agendamentos
                key: `${item.Colaborador}_${item.Data}_${item.Hora}`,
                colaborador: item.Colaborador,
                data: item.Data, // Assumindo formato YYYY-MM-DD vindo da planilha
                horario: item.Hora, // Assumindo formato HH:MM vindo da planilha
                nome: item.Responsavel, // Ajuste para o nome da coluna na sua planilha
                empreendimento: item.Empreendimento,
                local: item.Local,
                telefone: item.Telefone,
                observacoes: item.Observacoes,
                status: item.Status // Se houver coluna de status
            }))
            .sort((a, b) => {
                const dateA = new Date(`${a.data}T${a.horario}`);
                const dateB = new Date(`${b.data}T${b.horario}`);
                return dateA - dateB;
            });
    }

    static async clearAllData() {
        alert('Limpar todos os dados é uma operação crítica e DEVE ser implementada no Google Apps Script com devida segurança, não diretamente no frontend.');
        // Exemplo de como poderia ser, exigindo modificação no Apps Script:
        /*
        try {
            const res = await fetch(GOOGLE_SHEET_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'clearAll' })
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            currentAgendamentos = []; // Limpa o cache local
        } catch (err) {
            console.error('Erro ao limpar todos os dados:', err);
            alert('Falha ao limpar todos os dados. Verifique o Google Apps Script.');
        }
        */
    }
}
// --- DataManager END ---

async function initializeApp() {
    currentAgendamentos = await DataManager.getAllAgendamentosArray(); // Carrega os dados da planilha
    // Set default dates for filters
    const today = new Date().toISOString().split('T')[0];
    const dataInicioFilter = document.getElementById('filter-data-inicio');
    const dataFimFilter = document.getElementById('filter-data-fim');
    if (!dataInicioFilter.value) dataInicioFilter.value = today;
    if (!dataFimFilter.value) dataFimFilter.value = today;
    
    showSection('agendamento'); // Default section
}

async function showSection(section) {
    document.getElementById('section-agendamento').classList.add('hidden');
    document.getElementById('section-relatorios').classList.add('hidden');
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

    const targetSectionId = `section-${section}`;
    const targetButtonId = `btn-${section === 'agendamento' ? 'agendar' : 'relatorios'}`;

    document.getElementById(targetSectionId).classList.remove('hidden');
    document.getElementById(targetButtonId).classList.add('active');

    if (section === 'relatorios') {
        await loadReports();
    } else {
        // Recarregar agendamentos do G.Sheets sempre que voltar para a seção de agendamento
        currentAgendamentos = await DataManager.getAllAgendamentosArray();
        resetAgendamentoView();
    }
}

function resetAgendamentoView() {
    clearScreensAndForm();
    document.getElementById('collaborators').classList.remove('hidden');
    document.getElementById('selector').classList.add('hidden');
    document.getElementById('backButton').classList.add('hidden');
    selectedCollaborator = '';
    selectedDate = '';
    selectedHour = '';
}

function selectCollaborator(nome) {
    selectedCollaborator = nome;
    document.getElementById('collaborators').classList.add('hidden');
    document.getElementById('selector').classList.remove('hidden');
    document.getElementById('selectedCollaborator').innerText = `Agendar para: ${nome}`;
    document.getElementById('backButton').classList.remove('hidden'); // Show back button to select collaborator
    // Default to week view or let user choose
}

function goBack() { // Main back button logic
    const form = document.getElementById('form');
    const dayHours = document.getElementById('dayHours');
    const calendar = document.getElementById('calendar');
    const weekView = document.getElementById('weekView');
    const selector = document.getElementById('selector');

    if (form.style.display === 'flex') { // If form is visible, go back to day/week view
        cancelForm(); // This will handle going back to the correct view
    } else if (!dayHours.classList.contains('hidden')) { // If dayHours is visible, go back to month calendar
        showMonth();
    } else if (!calendar.classList.contains('hidden') || !weekView.classList.contains('hidden')) { // If calendar or weekView is visible, go to selector
        clearScreensAndForm();
        selector.classList.remove('hidden');
        document.getElementById('backButton').classList.remove('hidden'); // Keep back button to go to collaborators
    } else if (!selector.classList.contains('hidden')) { // If selector is visible, go to collaborators
        resetAgendamentoView();
    }
}

async function showMonth() {
    clearScreensAndForm();
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = '';
    calendarEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth(); // 0-indexed

    const monthName = today.toLocaleString('pt-BR', { month: 'long' });
    calendarEl.innerHTML = `<h2>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} / ${year}</h2>`;

    const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 (Sun) - 6 (Sat)
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const grid = document.createElement('div');
    grid.className = 'calendar-grid';

    const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
    weekDays.forEach(day => grid.innerHTML += `<div class='header-cell'>${day}</div>`);

    for (let i = 0; i < firstDayOfMonth; i++) {
        grid.innerHTML += `<div></div>`; // Empty cells for days before month starts
    }

    // Carrega agendamentos SEMPRE do Google Sheets aqui
    // Isso garante que você verá os agendamentos de outras pessoas
    currentAgendamentos = await DataManager.getAllAgendamentosArray(); 

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const currentDate = new Date(dateStr + 'T00:00:00'); // Para comparação de data, evite problemas de fuso horário
        const todayAtMidnight = new Date(new Date().toISOString().split('T')[0] + 'T00:00:00');

        let hasAvailable = false;
        if (currentDate >= todayAtMidnight) { // Only check availability for today or future
             hasAvailable = horarios.some(h => {
                 const key = `${selectedCollaborator}_${dateStr}_${h}`;
                 // Verifica se NÃO existe um agendamento para o colaborador, data e hora específicos
                 return !currentAgendamentos.some(ag => ag.key === key);
             });
        }
        
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (currentDate < todayAtMidnight) { // Past date
            dayCard.style.backgroundColor = '#dddddd';
            dayCard.style.cursor = 'not-allowed';
            dayCard.innerHTML = `${d}`;
        } else {
            dayCard.innerHTML = `${hasAvailable ? '' : '<div class="icon-red">🔴</div>'}${d}`;
            dayCard.onclick = () => openDay(dateStr);
        }
        grid.appendChild(dayCard);
    }
    calendarEl.appendChild(grid);
}

async function showWeek() {
    clearScreensAndForm();
    const weekViewEl = document.getElementById('weekView');
    weekViewEl.innerHTML = '<h2>Próximos 5 Dias Úteis</h2>';
    weekViewEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const today = new Date();
    const weekDates = [];

    let currentDate = new Date(today);
    // Find the next Monday if today is Sat/Sun, or start from today if it's a weekday
    if (currentDate.getDay() === 0) { // Sunday
        currentDate.setDate(currentDate.getDate() + 1);
    } else if (currentDate.getDay() === 6) { // Saturday
        currentDate.setDate(currentDate.getDate() + 2);
    }

    for (let i = 0; i < 5; i++) { // Get next 5 weekdays
        while (currentDate.getDay() === 0 || currentDate.getDay() === 6) { // Skip weekends
            currentDate.setDate(currentDate.getDate() + 1);
        }
        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
        const dayLabel = currentDate.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
        weekDates.push({ label: `${dayLabel} (${currentDate.getDate()}/${currentDate.getMonth()+1})`, dateStr });
        currentDate.setDate(currentDate.getDate() + 1);
    }

    const grid = document.createElement('div');
    grid.className = 'week-grid';

    // Carrega agendamentos SEMPRE do Google Sheets aqui
    currentAgendamentos = await DataManager.getAllAgendamentosArray();

    for (const day of weekDates) { // Use for...of para usar await dentro
        const column = document.createElement('div');
        const header = document.createElement('div');
        header.className = 'header-cell';
        header.innerText = day.label;
        column.appendChild(header);

        let availableSlots = false;
        horarios.forEach(hora => {
            const key = `${selectedCollaborator}_${day.dateStr}_${hora}`;
            // Verifica se NÃO existe um agendamento para o colaborador, data e hora específicos
            if (!currentAgendamentos.some(ag => ag.key === key)) {
                availableSlots = true;
                const btn = document.createElement('div');
                btn.className = 'hour';
                btn.innerText = hora;
                btn.onclick = () => selectHourAndShowForm(day.dateStr, hora);
                column.appendChild(btn);
            } else {
                // Adiciona o horário como "agendado" para que seja visível
                const btn = document.createElement('div');
                btn.className = 'hour booked'; // Adiciona classe 'booked'
                btn.innerText = hora;
                column.appendChild(btn);
            }
        });

        if (!availableSlots && new Date(day.dateStr + 'T00:00:00') >= new Date(new Date().toISOString().split('T')[0] + 'T00:00:00')) {
            const noAvailable = document.createElement('div');
            noAvailable.className = 'no-available';
            noAvailable.innerHTML = '🔴'; // Simpler indication for week view
            column.appendChild(noAvailable);
        }
        grid.appendChild(column);
    }
    weekViewEl.appendChild(grid);
}

async function openDay(dateStr) { // dateStr format YYYY-MM-DD
    clearScreensAndForm();
    const dayHoursEl = document.getElementById('dayHours');
    dayHoursEl.innerHTML = ''; // Clear previous content
    dayHoursEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const formattedDate = formatDateToBR(dateStr);
    dayHoursEl.innerHTML = `<h2>Horários para ${formattedDate}</h2>`;
    
    const container = document.createElement('div'); // For flex layout of hours
    container.className = 'day-hours-container';

    const currentDate = new Date(dateStr + 'T00:00:00');
    const todayAtMidnight = new Date(new Date().toISOString().split('T')[0] + 'T00:00:00');

    // Carrega agendamentos SEMPRE do Google Sheets aqui
    currentAgendamentos = await DataManager.getAllAgendamentosArray();

    let available = false;
    if (currentDate < todayAtMidnight) {
         const pastDateMsg = document.createElement('div');
         pastDateMsg.className = 'no-available';
         pastDateMsg.innerText = 'Não é possível agendar em datas passadas.';
         container.appendChild(pastDateMsg);
    } else {
        horarios.forEach(hora => {
            const key = `${selectedCollaborator}_${dateStr}_${hora}`;
            // Verifica se NÃO existe um agendamento para o colaborador, data e hora específicos
            if (!currentAgendamentos.some(ag => ag.key === key)) {
                available = true;
                const hourBtn = document.createElement('div');
                hourBtn.className = 'hour';
                hourBtn.innerText = hora;
                hourBtn.onclick = () => selectHourAndShowForm(dateStr, hora);
                container.appendChild(hourBtn);
            } else {
                // Adiciona o horário como "agendado" para que seja visível
                const hourBtn = document.createElement('div');
                hourBtn.className = 'hour booked'; // Adiciona classe 'booked'
                hourBtn.innerText = hora;
                container.appendChild(hourBtn);
            }
        });
    }

    if (!available && currentDate >= todayAtMidnight) {
        const noAvailable = document.createElement('div');
        noAvailable.className = 'no-available';
        noAvailable.innerText = '🔴 Sem horários disponíveis para este dia.';
        container.appendChild(noAvailable);
    }
    dayHoursEl.appendChild(container);

    // Back button within openDay is specific to going back to month view
    const backBtnDiv = document.createElement('div');
    backBtnDiv.className = 'back-button'; // Use existing class for styling
    backBtnDiv.style.marginTop = '20px';
    const specificBackBtn = document.createElement('button');
    specificBackBtn.innerHTML = '⬅ Voltar para o Calendário Mensal';
    specificBackBtn.onclick = () => showMonth();
    backBtnDiv.appendChild(specificBackBtn);
    dayHoursEl.appendChild(backBtnDiv);
}

function selectHourAndShowForm(date, hour) {
    selectedDate = date; // YYYY-MM-DD
    selectedHour = hour;
    document.getElementById('form').style.display = 'flex';
    document.getElementById('dayHours').classList.add('hidden'); // Hide day hours
    document.getElementById('weekView').classList.add('hidden'); // Hide week view
    document.getElementById('calendar').classList.add('hidden'); // Hide month calendar
    document.getElementById('nome').focus();
}

async function book() {
    const nome = document.getElementById('nome').value.trim();
    const empreendimento = document.getElementById('empreendimento').value.trim();
    const local = document.getElementById('local').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const observacoes = document.getElementById('observacoes').value.trim();

    if (!nome || !empreendimento || !local) {
        alert('Preencha os campos obrigatórios: Nome, Empreendimento e Local!');
        return;
    }

    // Antes de tentar agendar, verifica se o horário já não foi pego por outra pessoa
    // Isso é importante porque a interface é atualizada assincronamente.
    await DataManager.getAllAgendamentosArray(); // Atualiza currentAgendamentos com os dados mais recentes
    const keyToCheck = `${selectedCollaborator}_${selectedDate}_${selectedHour}`;
    if (currentAgendamentos.some(ag => ag.key === keyToCheck)) {
        alert('Este horário acabou de ser agendado por outra pessoa. Por favor, escolha outro.');
        // Recarrega a visualização para mostrar o slot como ocupado
        if (!document.getElementById('weekView').classList.contains('hidden')) {
            await showWeek();
        } else {
            await openDay(selectedDate);
        }
        clearForm();
        return;
    }

    const agendamentoData = {
        Colaborador: selectedCollaborator,
        Data: selectedDate,   // formato YYYY-MM-DD
        Hora: selectedHour,
        Responsavel: nome,
        Empreendimento: empreendimento,
        Local: local,
        Telefone: telefone,
        Observacoes: observacoes,
        Status: "Agendado" // Exemplo de status
    };

    await DataManager.addAgendamento(agendamentoData); // Esta função já atualiza currentAgendamentos

    alert(`Agendado para ${selectedCollaborator} em ${formatDateToBR(selectedDate)} às ${selectedHour} com sucesso!`);
    clearForm();
    resetAgendamentoView(); // Go back to collaborator selection
}

function clearForm() {
    const form = document.getElementById('form');
    form.style.display = 'none';
    document.getElementById('nome').value = '';
    document.getElementById('empreendimento').value = '';
    document.getElementById('local').value = '';
    document.getElementById('telefone').value = '';
    document.getElementById('observacoes').value = '';
}

function cancelForm() {
    clearForm();
    // Determine where to go back to (day view or week view)
    if(selectedDate){ // if a date was selected, user was likely in day or week view
        if (!document.getElementById('weekView').classList.contains('hidden')) {
            showWeek(); // Go back to week view if it was visible
        } else {
            openDay(selectedDate); // Go back to day view
        }
    } else {
       goBack(); // General back function if no date was selected (e.g., from selector)
    }
}

function clearScreensAndForm() {
    document.getElementById('calendar').classList.add('hidden');
    document.getElementById('dayHours').classList.add('hidden');
    document.getElementById('weekView').classList.add('hidden');
    clearForm();
}

// --- Funções de Relatório ---
async function loadReports() {
    await applyFilters(); // This will fetch and render
    await updateStats();
}

async function applyFilters() {
    const colaboradorFilter = document.getElementById('filter-colaborador').value;
    let dataInicioFilter = document.getElementById('filter-data-inicio').value;
    let dataFimFilter = document.getElementById('filter-data-fim').value;
    const empreendimentoFilter = document.getElementById('filter-empreendimento').value.toLowerCase();

    let dados = await DataManager.getAllAgendamentosArray(); // Sempre busca do Google Sheets

    // Ensure dates are comparable (Date objects at midnight UTC for YYYY-MM-DD)
    dataInicioFilter = dataInicioFilter ? new Date(dataInicioFilter + 'T00:00:00Z') : null;
    dataFimFilter = dataFimFilter ? new Date(dataFimFilter + 'T00:00:00Z') : null;

    if (colaboradorFilter) {
        dados = dados.filter(item => item.colaborador === colaboradorFilter);
    }
    if (dataInicioFilter) {
        dados = dados.filter(item => new Date(item.data + 'T00:00:00Z') >= dataInicioFilter);
    }
    if (dataFimFilter) {
        dados = dados.filter(item => new Date(item.data + 'T00:00:00Z') <= dataFimFilter);
    }
    if (empreendimentoFilter) {
        dados = dados.filter(item => item.empreendimento.toLowerCase().includes(empreendimentoFilter));
    }
    renderTable(dados);
}

function renderTable(dados) {
    const tbody = document.getElementById('reports-tbody');
    tbody.innerHTML = '';

    if (dados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">Nenhum agendamento encontrado para os filtros aplicados.</td></tr>';
        return;
    }

    dados.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDateToBR(item.data)}</td>
            <td>${item.horario}</td>
            <td>${item.colaborador}</td>
            <td>${item.nome}</td>
            <td>${item.empreendimento}</td>
            <td>${item.local}</td>
            <td>${item.telefone || '-'}</td>
            <td>${item.observacoes || '-'}</td>
            <td>
                <button class="action-btn" onclick="removeAgendamento('${item.key}')">
                    Excluir
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function updateStats() {
    const dados = await DataManager.getAllAgendamentosArray(); // Sempre busca do Google Sheets
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD for comparison

    // Adjust startOfWeek and endOfWeek to be Monday to Sunday of the CURRENT week
    let startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); // Monday
    startOfWeek.setHours(0, 0, 0, 0);

    let endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6); // Sunday
    endOfWeek.setHours(23, 59, 59, 999);
    
    const totalAgendamentos = dados.length;
    const agendamentosHoje = dados.filter(item => item.data === todayStr).length;
    const agendamentosSemana = dados.filter(item => {
        const itemDate = new Date(item.data + "T00:00:00"); // Ensure comparison at start of day
        return itemDate >= startOfWeek && itemDate <= endOfWeek;
    }).length;

    const agendamentosPorColaborador = dados.reduce((acc, item) => {
        acc[item.colaborador] = (acc[item.colaborador] || 0) + 1;
        return acc;
    }, {});

    const statsContainer = document.getElementById('stats-container');
    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${totalAgendamentos}</div>
            <div class="stat-label">Total Agendados</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${agendamentosHoje}</div>
            <div class="stat-label">Agendamentos Hoje</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${agendamentosSemana}</div>
            <div class="stat-label">Esta Semana (Seg-Dom)</div>
        </div>
    `;
    // Add stats for each collaborator dynamically
    Object.entries(agendamentosPorColaborador).forEach(([colaborador, count]) => {
        const statCard = document.createElement('div');
        statCard.className = 'stat-card';
        statCard.innerHTML = `
            <div class="stat-number">${count}</div>
            <div class="stat-label">${colaborador}</div>
        `;
        statsContainer.appendChild(statCard);
    });
     if (Object.keys(agendamentosPorColaborador).length === 0 && totalAgendamentos > 0) {
        // This case should not happen if data is consistent, but as a fallback
        statsContainer.innerHTML += `<div class="stat-card"><div class="stat-label">Nenhum colaborador com agendamentos.</div></div>`;
    }
}

async function removeAgendamento(key) {
    if (confirm('Tem certeza que deseja excluir este agendamento? Esta ação não pode ser desfeita e requer funcionalidade no Google Apps Script.')) {
        await DataManager.removeAgendamento(key); // Esta função precisa ser implementada no DataManager e no Apps Script
        await loadReports(); // Reload reports which also updates stats
        // alert('Agendamento excluído com sucesso!'); // Descomente se a exclusão for de fato implementada
    }
}

async function exportToCSV() {
    const dados = await DataManager.getAllAgendamentosArray(); // Sempre busca do Google Sheets
    if (dados.length === 0) {
        alert('Não há dados para exportar!');
        return;
    }
    // User request: Colaborador, Nome, empreendimento e local
    const headers = ['Colaborador', 'Nome Responsável', 'Empreendimento', 'Local', 'Data', 'Horário', 'Telefone', 'Observações'];
    
    const csvContent = [
        headers.join(','),
        ...dados.map(item => [
            `"${item.colaborador}"`,
            `"${item.nome}"`,
            `"${item.empreendimento}"`,
            `"${item.local}"`,
            formatDateToBR(item.data),
            item.horario,
            `"${item.telefone || ''}"`,
            `"${(item.observacoes || '').replace(/"/g, '""')}"` // Escape double quotes
        ].join(','))
    ].join('\n');

    downloadFile(csvContent, 'agendamentos_vistorias.csv', 'text/csv;charset=utf-8;');
}

function exportToPDF() {
    alert('Funcionalidade de exportação para PDF ainda não implementada. Considere usar a impressão do navegador (Ctrl+P) e "Salvar como PDF" ou uma biblioteca como jsPDF para uma solução mais robusta.');
}

async function clearAllData() {
    if (confirm('ATENÇÃO: Isto irá solicitar a exclusão de TODOS os agendamentos. Esta é uma operação crítica e requer uma implementação no seu Google Apps Script com devida autenticação e cuidado. Tem certeza?')) {
        await DataManager.clearAllData(); // Esta função precisa ser implementada no Apps Script
        await loadReports();
    }
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function formatDateToBR(dateStr) { // YYYY-MM-DD to DD/MM/YYYY
    if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr; // Return original if invalid
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
}

function formatDateToISO(dateStr) { // DD/MM/YYYY to YYYY-MM-DD
    if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return dateStr;
    const [day, month, year] = dateStr.split('/');
    return `${year}-${month}-${day}`;
}

// Inicializar ao carregar a página
document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>
